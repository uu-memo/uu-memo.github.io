---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { getCollection, getEntry } from "astro:content";

const allPosts = await getCollection("posts");
const sortedPosts = allPosts.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const latestPosts = sortedPosts.slice(0, 3);
const featuredPosts = sortedPosts.filter((post) => 
    post.data.tags?.includes("精選")
).slice(0, 4);

// Extract unique categories
const categories = [...new Set(allPosts.flatMap(post => post.data.category || []))].filter(Boolean);
// Extract top tags (most frequent)
const tagsCount = allPosts.flatMap(post => post.data.tags || []).reduce((acc, tag) => {
    acc[tag] = (acc[tag] || 0) + 1;
    return acc;
}, {} as Record<string, number>);
const topTags = Object.entries(tagsCount)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .map(t => t[0]);

// Load author bio from about.md (first non-empty, non-HTML paragraph)
const aboutPage = await getEntry("pages", "about");
const aboutRawBody = aboutPage?.body || "";
const aboutBio = aboutRawBody
    .split(/\n+/)
    .map((l: string) => l.trim())
    .filter((l: string) => l && !l.startsWith('<') && !l.startsWith('#') && !l.startsWith('---'))
    [0] || "在這裡記錄生活的碎片。";
---

<Layout title="UU MEMO - 紀錄生活碎隙">
    <Header />

    <main class="max-w-6xl mx-auto px-6 py-12">
        <div class="flex flex-col lg:flex-row gap-16">
            <!-- Left Content Area (Main) -->
            <div class="flex-1 space-y-20">
                <!-- 最新文章 (Horizontal Cards) -->
                <section>
                    <div class="flex justify-between items-end mb-8">
                        <h2
                            class="text-2xl font-bold tracking-tight border-b-2 border-uu-main pb-1"
                        >
                            最新文章
                        </h2>
                        <span
                            class="text-xs opacity-40 font-mono tracking-widest"
                            >LATEST UPDATES</span
                        >
                    </div>

                    <div class="space-y-8">
                        {
                            latestPosts.map((post, index) => (
                                <>
                                    <article class="flex flex-col md:flex-row gap-6 group">
                                        <a
                                            href={`/posts/${post.id}`}
                                            class="w-full md:w-72 aspect-[16/10] bg-uu-sub/30 rounded-lg overflow-hidden shrink-0 block"
                                        >
                                            {post.data.heroImage ? (
                                                <img
                                                    src={post.data.heroImage}
                                                    alt={post.data.title}
                                                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                                />
                                            ) : (
                                                <div class="w-full h-full bg-[#eaddce] flex items-center justify-center text-uu-main/20">
                                                    <span class="material-symbols-outlined text-5xl">
                                                        image
                                                    </span>
                                                </div>
                                            )}
                                        </a>
                                        <div class="flex flex-col justify-center">
                                            <div class="text-[10px] tracking-widest text-uu-main/60 mb-2 font-medium flex items-center gap-1">
                                                <span>
                                                    {post.data.pubDate
                                                        .toISOString()
                                                        .split("T")[0]
                                                        .replace(/-/g, ".")}
                                                </span>{" "}
                                                /
                                                <a
                                                    href={`/category/${post.data.category?.[0] || "life"}`}
                                                    class="hover:text-uu-main hover:underline decoration-1 underline-offset-2 transition-colors"
                                                >
                                                    {post.data.category?.[0] ||
                                                        "生活記事"}
                                                </a>
                                            </div>
                                            <h3 class="text-xl font-bold mb-3 group-hover:text-uu-dark transition-colors">
                                                <a href={`/posts/${post.id}`}>
                                                    {post.data.title}
                                                </a>
                                            </h3>
                                            <p class="text-sm leading-relaxed opacity-70 line-clamp-2 mb-4">
                                                {post.data.description}
                                            </p>
                                        </div>
                                    </article>
                                    {index < latestPosts.length - 1 && (
                                        <div class="h-px bg-uu-sub/50 w-full" />
                                    )}
                                </>
                            ))
                        }
                    </div>
                    <div class="mt-8 text-right">
                        <a
                            href="/posts"
                            class="btn-text text-sm font-bold tracking-widest text-uu-main/80 hover:text-uu-main"
                            >看所有文章 →</a
                        >
                    </div>
                </section>

                <!-- 精選文章 (Vertical Cards) -->
                <section>
                    <div class="flex justify-between items-end mb-8">
                        <h2
                            class="text-2xl font-bold tracking-tight border-b-2 border-uu-main pb-1"
                        >
                            精選文章
                        </h2>
                        <span
                            class="text-xs opacity-40 font-mono tracking-widest"
                            >FEATURED POSTS</span
                        >
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {
                            featuredPosts.map((post) => (
                                <article class="bg-uu-light rounded-2xl overflow-hidden border border-uu-sub group shadow-sm hover:shadow-md transition-shadow">
                                    <a href={`/posts/${post.id}`}>
                                        <div class="aspect-[16/9] bg-uu-sub/20 relative overflow-hidden">
                                            {post.data.heroImage ? (
                                                <img
                                                    src={post.data.heroImage}
                                                    alt={post.data.title}
                                                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                                />
                                            ) : (
                                                <div class="absolute inset-0 flex items-center justify-center text-uu-main/20">
                                                    <span class="material-symbols-outlined text-4xl">
                                                        photo_library
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                    </a>
                                    <div class="p-6">
                                        <h3 class="text-lg font-bold mb-3 group-hover:text-uu-dark transition-colors">
                                            <a href={`/posts/${post.id}`}>
                                                {post.data.title}
                                            </a>
                                        </h3>
                                        <p class="text-sm opacity-70 line-clamp-3 mb-6 leading-relaxed">
                                            {post.data.description}
                                        </p>
                                    </div>
                                </article>
                            ))
                        }
                    </div>
                    <div class="mt-8 text-right">
                        <a
                            href="/category/精選文章"
                            class="btn-text text-sm font-bold tracking-widest text-uu-main/80 hover:text-uu-main"
                            >看所有精選 →</a
                        >
                    </div>
                </section>
            </div>

            <!-- Right Sidebar -->
            <aside class="w-full lg:w-72 space-y-12 shrink-0">
                <!-- Author Bio -->
                <section
                    class="bg-uu-light p-8 rounded-2xl border border-uu-sub text-center"
                >
                    <div
                        class="w-20 h-20 mx-auto bg-uu-sub/30 rounded-full flex items-center justify-center mb-6 overflow-hidden"
                    >
                        <img
                            src="/uu-memo.png"
                            alt="UU Avatar"
                            class="w-full h-full object-cover"
                        />
                    </div>
                    <h4 class="font-bold text-lg mb-2">UU</h4>
                    <p class="text-xs opacity-60 mb-6 tracking-widest">
                        WRITER / PHOTOGRAPHER
                    </p>
                    <p class="text-sm leading-relaxed opacity-80 mb-6">
                        {aboutBio}
                    </p>
                    <div class="flex justify-center gap-4">
                        <a
                            href="mailto:uu-memo@outlook.com"
                            class="text-uu-main/50 hover:text-uu-main transition-colors"
                        >
                            <span class="material-symbols-outlined">mail</span>
                        </a>
                        <a
                            href="/contact"
                            class="text-uu-main/50 hover:text-uu-main transition-colors"
                            title="聯絡我"
                        >
                            <span class="material-symbols-outlined"
                                >alternate_email</span
                            >
                        </a>
                    </div>
                </section>

                <!-- Directory (Sitemap Index) -->
                <section>
                    <h4
                        class="text-sm font-bold tracking-widest border-b border-uu-sub pb-2 mb-6 uppercase"
                    >
                        目錄索引
                    </h4>
                    <ul class="space-y-4 text-sm font-medium">
                        {
                            categories.map((cat) => (
                                <li>
                                    <a
                                        href={`/category/${cat}`}
                                        class="flex items-center justify-between group"
                                    >
                                        <span class="group-hover:translate-x-1 transition-transform">
                                            {cat}
                                        </span>
                                        <span class="material-symbols-outlined text-sm opacity-30">
                                            chevron_right
                                        </span>
                                    </a>
                                </li>
                            ))
                        }
                    </ul>
                </section>

                <!-- Tag Cloud (Optional decoration) -->
                <section>
                    <h4
                        class="text-sm font-bold tracking-widest border-b border-uu-sub pb-2 mb-6 uppercase"
                    >
                        熱門標籤
                    </h4>
                    <div class="flex flex-wrap gap-2">
                        {
                            topTags.map((tag) => (
                                <a
                                    href={`/posts?tag=${tag}`}
                                    class="text-[11px] px-3 py-1 bg-uu-sub/20 rounded-full hover:bg-uu-main hover:text-white transition-colors cursor-pointer"
                                >
                                    #{tag}
                                </a>
                            ))
                        }
                    </div>
                </section>
            </aside>
        </div>
    </main>

    <Footer />
</Layout>
