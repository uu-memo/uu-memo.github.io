---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import PrimaryButton from "../../components/PrimaryButton.astro";
---

<Layout title="Admin Management | UU MEMO">
    <Header />

    <main
        class="max-w-6xl mx-auto px-6 py-12 md:py-20 min-h-[85vh] flex flex-col w-full self-stretch"
    >
        <!-- Auth Loading -->
        <div
            id="auth-loading"
            class="fixed inset-0 z-[60] bg-uu-base flex flex-col items-center justify-center space-y-4 transition-opacity duration-300"
        >
            <div
                class="w-12 h-12 border-4 border-uu-sub border-t-uu-main rounded-full animate-spin"
            >
            </div>
            <p
                class="text-uu-main/60 tracking-widest text-sm font-medium uppercase"
            >
                Authenticating...
            </p>
        </div>

        <!-- Admin Login UI (Intermediate Page) -->
        <div
            id="admin-login-ui"
            class="hidden fixed inset-0 z-50 bg-uu-base flex flex-col items-center justify-center px-6"
        >
            <div class="max-w-md w-full bg-white rounded-[2rem] p-10 shadow-xl border border-uu-sub/20 text-center space-y-8 animate-in fade-in zoom-in duration-500">
                <div class="w-20 h-20 bg-uu-main/10 rounded-full flex items-center justify-center mx-auto border-4 border-white shadow-sm">
                    <span class="material-symbols-outlined text-uu-main text-4xl">admin_panel_settings</span>
                </div>
                
                <div class="space-y-2">
                    <h2 class="text-2xl font-bold text-uu-dark font-logo uppercase tracking-wider">Restricted Access</h2>
                    <p class="text-sm text-uu-main/60 leading-relaxed">This area is reserved for administrators only. Please sign in with an authorized Google account to continue.</p>
                </div>

                <div id="unauthorized-msg" class="hidden p-4 bg-red-50 rounded-xl border border-red-100">
                    <p class="text-[10px] text-red-500 font-bold uppercase tracking-widest mb-1">Access Denied</p>
                    <p id="denied-email" class="text-xs text-red-400 font-mono italic mb-3"></p>
                    <p class="text-[10px] text-red-400 leading-tight">Please ensure your email is granted permission in Firestore rules.</p>
                </div>

                <button
                    id="admin-login-btn"
                    class="w-full py-4 bg-uu-dark text-white rounded-2xl flex items-center justify-center gap-3 font-black tracking-[0.2em] uppercase hover:bg-uu-main transition-all active:scale-95 shadow-lg shadow-uu-dark/10 group"
                >
                    <span class="material-symbols-outlined group-hover:rotate-12 transition-transform">login</span>
                    Sign in with Google
                </button>

                <p class="text-[10px] text-uu-main/30 font-bold uppercase tracking-[0.3em]">Authorized Personnel Only</p>
            </div>
        </div>

        <!-- Admin Dashboard Container (Exact Mirror of User Dashboard Layout) -->
        <div
            id="admin-dashboard"
            class="hidden opacity-0 transition-opacity duration-500 dashboard-layout w-full"
        >
            <!-- LEFT COLUMN: Sidebar -->
            <aside class="dashboard-sidebar">
                <div
                    class="bg-uu-light p-8 rounded-2xl border border-uu-sub/30 shadow-sm flex flex-col items-center text-center"
                >
                    <div
                        class="w-20 h-20 bg-uu-main/10 rounded-full flex items-center justify-center overflow-hidden border-4 border-white shadow-sm mb-4 shrink-0"
                    >
                        <span
                            class="material-symbols-outlined text-uu-main text-4xl"
                            >admin_panel_settings</span
                        >
                    </div>

                    <div class="w-full">
                        <h1
                            class="text-lg font-bold font-logo text-uu-dark mb-0.5 truncate px-2"
                        >
                            ADMINISTRATOR
                        </h1>
                        <p
                            id="admin-email"
                            class="text-[10px] text-uu-main/60 tracking-wider font-mono truncate px-2"
                        >
                        </p>
                    </div>

                    <div
                        class="w-8 h-0.5 bg-uu-sub/20 rounded-full my-6 shrink-0"
                    >
                    </div>

                    <nav class="w-full flex flex-col gap-1.5">
                        <button
                            class="tab-btn active group flex items-center gap-3.5 px-4 py-3 rounded-xl transition-all w-full bg-uu-main text-white shadow-sm text-left"
                            data-tab="editor"
                        >
                            <span class="material-symbols-outlined text-xl"
                                >edit_note</span
                            >
                            <span
                                class="text-sm font-bold tracking-widest leading-none"
                                >æ–‡ç« ç·¨è¼¯</span
                            >
                        </button>
                        <button
                            class="tab-btn group flex items-center gap-3.5 px-4 py-3 rounded-xl transition-all w-full text-uu-main/60 hover:bg-uu-sub/10 hover:text-uu-main text-left"
                            data-tab="draft"
                        >
                            <span class="material-symbols-outlined text-xl"
                                >auto_fix</span
                            >
                            <span
                                class="text-sm font-bold tracking-widest leading-none"
                                >è‰ç¨¿å·¥å…·</span
                            >
                        </button>
                        <button
                            class="tab-btn group flex items-center gap-3.5 px-4 py-3 rounded-xl transition-all w-full text-uu-main/60 hover:bg-uu-sub/10 hover:text-uu-main text-left"
                            data-tab="comments"
                        >
                            <span class="material-symbols-outlined text-xl"
                                >forum</span
                            >
                            <span
                                class="text-sm font-bold tracking-widest leading-none"
                                >ç•™è¨€ç®¡ç†</span
                            >
                        </button>
                        <button
                            class="tab-btn group flex items-center gap-3.5 px-4 py-3 rounded-xl transition-all w-full text-uu-main/60 hover:bg-uu-sub/10 hover:text-uu-main text-left"
                            data-tab="author"
                        >
                            <span class="material-symbols-outlined text-xl"
                                >person_edit</span
                            >
                            <span
                                class="text-sm font-bold tracking-widest leading-none"
                                >ä½œè€…è¨­å®š</span
                            >
                        </button>
                        <button
                            class="tab-btn group flex items-center gap-3.5 px-4 py-3 rounded-xl transition-all w-full text-uu-main/60 hover:bg-uu-sub/10 hover:text-uu-main text-left"
                            data-tab="system"
                        >
                            <span class="material-symbols-outlined text-xl"
                                >tune</span
                            >
                            <span
                                class="text-sm font-bold tracking-widest leading-none"
                                >å…¨ç«™è¨­å®š</span
                            >
                        </button>

                        <div class="h-2"></div>

                        <button
                            id="logout-btn"
                            class="w-full flex items-center gap-3.5 px-4 py-3 rounded-xl text-uu-main/40 hover:text-uu-main hover:bg-uu-sub/10 transition-all group border border-transparent hover:border-uu-sub/20 text-left mt-2 cursor-pointer"
                        >
                            <span class="material-symbols-outlined text-xl"
                                >logout</span
                            >
                            <span
                                class="text-sm font-bold tracking-widest leading-none"
                                >ç™»å‡º</span
                            >
                        </button>
                    </nav>
                </div>
            </aside>

            <!-- RIGHT COLUMN: Content -->
            <div
                class="dashboard-content bg-uu-light rounded-2xl border border-uu-sub/30 shadow-sm min-h-[700px] flex flex-col overflow-hidden"
            >
                <!-- CONTENT: EDITOR -->
                <section
                    id="tab-editor"
                    class="tab-content w-full flex-1 flex flex-col p-10"
                >
                    <div
                        class="flex items-center gap-3.5 mb-8 pb-6 border-b border-uu-sub/20"
                    >
                        <div
                            class="w-10 h-10 rounded-full bg-uu-sub/10 flex items-center justify-center text-uu-main"
                        >
                            <span class="material-symbols-outlined"
                                >description</span
                            >
                        </div>
                        <h3 class="font-bold text-xl text-uu-dark">å…§å®¹å‰µä½œ</h3>
                    </div>

                    <div class="space-y-8 flex-1">
                        <!-- Top Meta -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest"
                                    >Article Slug</label
                                >
                                <input
                                    id="post-slug"
                                    type="text"
                                    class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all"
                                    placeholder="ä¾‹å¦‚: 2024-spring-trip"
                                />
                            </div>
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest"
                                    >Visibility</label
                                >
                                <div class="relative">
                                    <select
                                        id="post-status"
                                        class="w-full appearance-none bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all pr-10"
                                    >
                                        <option value="public"
                                            >ç«‹å³ç™¼ä½ˆ (Public)</option
                                        >
                                        <option value="private"
                                            >ç§å¯†é–±è®€ (Private)</option
                                        >
                                    </select>
                                    <span
                                        class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-uu-main/40 pointer-events-none"
                                        >expand_more</span
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Markdown Upload Dropzone -->
                        <div
                            id="md-dropzone"
                            class="border-2 border-dashed border-uu-sub/30 rounded-2xl py-12 flex flex-col items-center justify-center gap-3 transition-colors hover:border-uu-main/50 hover:bg-uu-sub/5 group cursor-pointer"
                        >
                            <input
                                type="file"
                                id="md-file-input"
                                accept=".md"
                                class="hidden"
                            />
                            <span
                                class="material-symbols-outlined text-4xl text-uu-main/30 group-hover:text-uu-main transition-colors"
                                >cloud_upload</span
                            >
                            <div class="text-center">
                                <p class="text-xs font-bold text-uu-main/60">
                                    æ‹–ç§» .md æª”æ¡ˆè‡³æ­¤ï¼Œæˆ–é»æ“Šé¸æ“‡
                                </p>
                                <p
                                    class="text-[10px] text-uu-main/30 mt-1 italic"
                                >
                                    ç³»çµ±å°‡è‡ªå‹•è®€å–å…§å®¹ä¸¦å˜—è©¦ç”Ÿæˆ Slug
                                </p>
                            </div>
                        </div>

                        <!-- Editor -->
                        <div class="space-y-2 flex-1 flex flex-col">
                            <label
                                class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest"
                                >Markdown Editor</label
                            >
                            <textarea
                                id="md-content"
                                class="w-full flex-1 min-h-[500px] bg-uu-base/10 border border-uu-sub/10 rounded-2xl p-8 text-sm font-mono leading-relaxed focus:outline-none focus:bg-white transition-all shadow-inner"
                                placeholder="# æ¨™é¡Œ..."></textarea>
                        </div>

                        <!-- Image Workshop -->
                        <div class="space-y-6 pt-6 border-t border-uu-sub/20">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span
                                        class="material-symbols-outlined text-uu-main"
                                        >image</span
                                    >
                                    <h4 class="font-bold text-sm text-uu-dark">
                                        å½±åƒå·¥åŠ
                                    </h4>
                                </div>
                                <input
                                    type="file"
                                    id="image-input"
                                    multiple
                                    accept="image/*"
                                    class="hidden"
                                />
                                <button
                                    onclick="document.getElementById('image-input').click()"
                                    class="px-4 py-2 bg-uu-sub/10 text-uu-main hover:bg-uu-main hover:text-white rounded-lg text-[10px] font-black tracking-widest uppercase transition-all active:scale-95"
                                    >æ‰¹æ¬¡ä¸Šå‚³ç…§ç‰‡</button
                                >
                            </div>

                            <div
                                id="image-queue"
                                class="grid grid-cols-1 sm:grid-cols-2 gap-4"
                            >
                                <!-- Dynamic Preview Cards -->
                            </div>
                        </div>

                        <div class="pt-8">
                            <PrimaryButton 
                                id="final-push-btn" 
                                text="SYNC TO GITHUB" 
                                icon="send"
                            />
                        </div>
                    </div>
                </section>

                <!-- CONTENT: DRAFT TOOL -->
                <section id="tab-draft" class="tab-content hidden w-full flex-1 flex flex-col p-10">
                    <div class="flex items-center gap-3.5 mb-8 pb-6 border-b border-uu-sub/20">
                        <div class="w-10 h-10 rounded-full bg-uu-sub/10 flex items-center justify-center text-uu-main">
                            <span class="material-symbols-outlined">auto_fix</span>
                        </div>
                        <h3 class="font-bold text-xl text-uu-dark">æ–‡ç« è‰ç¨¿å·¥å…·</h3>
                    </div>

                    <div class="space-y-8 flex-1 overflow-y-auto pr-4 no-scrollbar">
                        <div class="grid grid-cols-1 gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">1. æ–‡ç« æš«å®šæ¨™é¡Œæˆ–ä¸»é¡Œæ–¹å‘</label>
                                <input id="draft-q1" type="text" class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all" placeholder="è«‹åœ¨æ­¤å¡«å¯«">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">2. ç›®æ¨™å—çœ¾ï¼ˆé€™ç¯‡æ–‡ç« å¯«çµ¦èª°çœ‹ï¼‰</label>
                                <input id="draft-q2" type="text" class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all" placeholder="è«‹åœ¨æ­¤å¡«å¯«">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">3. æ ¸å¿ƒè§€é»èˆ‡ç›®çš„</label>
                                <input id="draft-q3" type="text" class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all" placeholder="è®€å®Œé€™ç¯‡æ–‡ç« ï¼Œè®€è€…èƒ½å¸¶èµ°ä»€éº¼ï¼Ÿ">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">4. é—œéµæ®µè½èˆ‡å¤§ç¶±ï¼ˆåˆ—å‡º 3-5 å€‹é‡é»ï¼‰</label>
                                <textarea id="draft-q4" class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all min-h-[120px]" placeholder="- é‡é» 1ï¼š&#10;- é‡é» 2ï¼š&#10;- é‡é» 3ï¼š"></textarea>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">5. å€‹äººç¨ç‰¹ç¶“é©—èˆ‡ç´°ç¯€ï¼ˆæ–‡ç« çš„éˆé­‚ï¼‰</label>
                                <textarea id="draft-q5" class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all min-h-[150px]" placeholder="è«‹åœ¨æ­¤å¡«å¯«ä½ æƒ³æ”¾å…¥çš„å…·é«”ç´°ç¯€"></textarea>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">6. è¡Œæ–‡èªæ°£èˆ‡é¢¨æ ¼</label>
                                <input id="draft-q6" type="text" class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all" placeholder="é è¨­ï¼šè¼•é¬†å¹½é»˜çš„å€‹äººéš¨ç­†">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">æ–‡ç« çŸ­ç¶²å€ (Slug)</label>
                                    <input id="draft-slug" type="text" class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all" placeholder="ä¾‹å¦‚: 2024-trip">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">åˆ†é¡ (Category)</label>
                                    <input id="draft-cat" type="text" class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all" placeholder="ä¾‹å¦‚ï¼šç”Ÿæ´»éš¨ç­†">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">æ¨™ç±¤ (Tags)</label>
                                    <input id="draft-tags" type="text" class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all" placeholder="ç”¨é€—è™Ÿåˆ†éš”">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2 mt-6 p-6 bg-uu-main/5 rounded-2xl border border-uu-main/10 shadow-inner">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-[10px] font-black text-uu-main uppercase tracking-widest flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">settings_suggest</span>
                                    é€²éšï¼šç·¨è¼¯é è¨­æŒ‡ä»¤æ¨¡æ¿ (Prompt Template)
                                </label>
                                <button id="save-template-btn" class="flex items-center gap-1.5 px-3 py-1 bg-white border border-uu-main/20 text-uu-main rounded-lg text-[10px] font-black tracking-widest uppercase hover:bg-uu-main hover:text-white transition-all shadow-sm">
                                    <span class="material-symbols-outlined text-xs">cloud_upload</span>
                                    å„²å­˜åˆ°è³‡æ–™åº«
                                </button>
                            </div>
                            <textarea id="draft-template" class="w-full bg-white border border-uu-sub/20 rounded-xl px-4 py-3 text-[11px] focus:outline-none focus:border-uu-main transition-all min-h-[400px] font-mono leading-relaxed" placeholder="åœ¨é€™è£¡è¨­å®šä½ çš„ Prompt éª¨æ¶..."># Role: éƒ¨è½æ ¼ä½œå®¶èˆ‡å…§å®¹ç­–ç•¥å¸«

è«‹æ ¹æ“šæˆ‘ä¸‹æ–¹æä¾›çš„ã€æ–‡ç« è‰ç¨¿è¡¨å–®ã€‘è³‡è¨Šï¼Œç‚ºæˆ‘æ’°å¯«ä¸€ç¯‡çµæ§‹å®Œæ•´ã€å¼•äººå…¥å‹ä¸”å…·å‚™å€‹äººè§€é»çš„éƒ¨è½æ ¼æ–‡ç« ã€‚

## ğŸ“¥ ã€æ–‡ç« è‰ç¨¿è¡¨å–®ã€‘ï¼ˆUser Inputï¼‰

1. **æ–‡ç« æš«å®šæ¨™é¡Œæˆ–ä¸»é¡Œæ–¹å‘ï¼š** &#123;&#123;q1&#125;&#125;
2. **ç›®æ¨™å—çœ¾ï¼ˆé€™ç¯‡æ–‡ç« å¯«çµ¦èª°çœ‹ï¼‰ï¼š** &#123;&#123;q2&#125;&#125;
3. **æ ¸å¿ƒè§€é»èˆ‡ç›®çš„ï¼ˆè®€å®Œé€™ç¯‡æ–‡ç« ï¼Œè®€è€…èƒ½å¸¶èµ°ä»€éº¼ï¼Ÿï¼‰ï¼š** &#123;&#123;q3&#125;&#125;
4. **é—œéµæ®µè½èˆ‡å¤§ç¶±ï¼ˆåˆ—å‡º 3-5 å€‹é‡é»ï¼‰ï¼š**
&#123;&#123;q4&#125;&#125;
5. **å€‹äººç¨ç‰¹ç¶“é©—èˆ‡ç´°ç¯€ï¼ˆå¿…å¡«ï¼Œé€™æ˜¯æ–‡ç« çš„éˆé­‚ï¼‰ï¼š**
   &#123;&#123;q5&#125;&#125;
6. **è¡Œæ–‡èªæ°£èˆ‡é¢¨æ ¼ï¼š**
   &#123;&#123;q6&#125;&#125;

---

## ğŸ“¤ è¼¸å‡ºè¦æ±‚ (Output Requirements)

è«‹åš´æ ¼éµå®ˆä»¥ä¸‹è¦å‰‡æ’°å¯«æ–‡ç« ï¼š
1. **Markdown æ ¼å¼**ï¼šè«‹ä½¿ç”¨æ¨™æº– Markdown èªæ³•æ’ç‰ˆï¼ˆåŒ…å« H2 ##ã€H3 ### æ¨™é¡Œã€ç²—é«”ã€æ¢åˆ—å¼æ¸…å–®ã€å¼•ç”¨å€å¡Šã€è¡¨æ ¼ç­‰ï¼‰ï¼Œç¢ºä¿æ–‡ç« å±¤æ¬¡åˆ†æ˜ã€æ˜“æ–¼é–±è®€ã€‚
2. **å¸å¼•äººçš„é–‹å ´**ï¼šç¬¬ä¸€æ®µå¿…é ˆé»å‡ºç—›é»æˆ–å¼•èµ·å…±é³´ï¼Œç›´æ¥ç ´é¡Œï¼Œå¸å¼•è®€è€…å¾€ä¸‹çœ‹ã€‚
3. **ç„¡ç¸«èå…¥å€‹äººç´°ç¯€**ï¼šè«‹å°‡è¡¨å–®ç¬¬ 5 é»çš„ã€Œå€‹äººç¨ç‰¹ç¶“é©—ã€è‡ªç„¶åœ°æ‰åˆé€²æ–‡ç« æ®µè½ä¸­ï¼Œä¸è¦åƒæ˜¯ç”Ÿç¡¬çš„æ¢åˆ—ï¼Œè¦å¸¶æœ‰ã€Œäººå‘³ã€ã€‚
4. **æµæš¢çš„è½‰æŠ˜**ï¼šæ®µè½ä¹‹é–“å¿…é ˆæœ‰é‚è¼¯é€£è²«çš„éæ¸¡å¥ã€‚
5. **æœ‰åŠ›é‡çš„çµå°¾**ï¼šç¸½çµæ ¸å¿ƒè§€é»ï¼Œä¸¦æä¾›ä¸€å€‹ Call to Actionï¼ˆä¾‹å¦‚ï¼šå•è®€è€…ä¸€å€‹å•é¡Œã€é¼“å‹µä»–å€‘ç•™è¨€ã€æˆ–åˆ†äº«ä¸‹ä¸€æ­¥è¨ˆç•«ï¼‰ã€‚

### ã€ç”Ÿæˆ .md å‰ç¶´ã€‘
ç•¶æˆ‘å›ç­”å®Œä¸Šè¿°å•é¡Œå¾Œï¼Œè«‹ä½ ã€Œå¸æ”¶ã€æˆ‘çš„å›ç­”ï¼Œä¸¦**ç›´æ¥ç”¢å‡ºä¸€æ®µå®Œæ•´çš„ Markdown (.md) ç¨‹å¼ç¢¼å€å¡Š**ã€‚

è«‹åš´æ ¼éµå®ˆä»¥ä¸‹è¼¸å‡ºæ ¼å¼ï¼š

```markdown
---
title: "ã€{{cat}}ã€‘å¹«æˆ‘æƒ³ä¸€å€‹å¸ç›çš„ä¸»é¡Œæ¨™é¡Œ"
description: "è«‹æ ¹æ“šæ–‡ç« å…§å®¹ç”Ÿæˆç´„ 50 å­—çš„æº«æš– SEO æ‘˜è¦"
publishDate: {{date}}
category: [{{cat}}]
tags: [{{tags}}]
heroImage: '/images/{{datePath}}/{{datePath}}-{{slug}}-01.jpg'
---
```</textarea>
                            <p class="text-[9px] text-uu-main/40 mt-1">æ‚¨å¯ä»¥ä½¿ç”¨ <code class="bg-white px-1 py-0.5 rounded shadow-sm border border-uu-sub/10 opacity-80">&#123;&#123;è®Šæ•¸&#125;&#125;</code> ä¾†æ›¿æ›ä¸Šæ–¹è¡¨å–®å…§å®¹ï¼Œä¾‹å¦‚ï¼š&#123;&#123;q1&#125;&#125;, &#123;&#123;cat&#125;&#125;, &#123;&#123;tags&#125;&#125;</p>
                        </div>

                        <div class="pt-6">
                            <PrimaryButton id="generate-draft-btn" text="ç”Ÿæˆæ–‡ç« è‰ç¨¿ PROMPT" icon="temp_preferences_custom" />
                        </div>

                        <div id="draft-result-container" class="hidden space-y-4 animate-fade-in pb-10">
                            <div class="flex items-center justify-between">
                                <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">ç”Ÿæˆçš„ AI PROMPT</label>
                                <button id="copy-prompt-btn" class="flex items-center gap-2 px-3 py-1.5 bg-uu-main/10 text-uu-main rounded-lg text-[10px] font-black tracking-widest uppercase hover:bg-uu-main hover:text-white transition-all">
                                    <span class="material-symbols-outlined text-sm">content_copy</span>
                                    è¤‡è£½å…§å®¹
                                </button>
                            </div>
                            <textarea id="draft-result" readonly class="w-full bg-white border border-uu-sub/30 rounded-2xl p-6 text-xs font-mono leading-relaxed h-[400px] focus:outline-none shadow-sm"></textarea>
                        </div>
                    </div>
                </section>

                <!-- CONTENT: COMMENTS -->
                <section
                    id="tab-comments"
                    class="tab-content hidden w-full flex-1 flex flex-col p-10"
                >
                    <div
                        class="flex items-center justify-between mb-8 pb-6 border-b border-uu-sub/20"
                    >
                        <div class="flex items-center gap-3.5">
                            <div
                                class="w-10 h-10 rounded-full bg-uu-sub/10 flex items-center justify-center text-uu-main"
                            >
                                <span class="material-symbols-outlined"
                                    >forum</span
                                >
                            </div>
                            <h3 class="font-bold text-xl text-uu-dark">
                                ç•™è¨€ç®¡ç†
                            </h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <button
                                id="seed-comments-btn"
                                class="px-3 py-1.5 border border-uu-sub/30 rounded-full text-[9px] font-black text-uu-main/40 hover:bg-uu-main hover:text-white transition-all uppercase tracking-widest"
                                >Seed Test Data</button
                            >
                            <div
                                id="comment-stats"
                                class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest bg-uu-base/50 px-3 py-1.5 rounded-full border border-uu-sub/20"
                            >
                                Loading...
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="flex gap-2 mb-6">
                        <button class="comment-filter active px-4 py-2 rounded-full text-[10px] font-bold tracking-widest border border-uu-sub/30 bg-white text-uu-dark transition-all hover:border-uu-main" data-filter="latest">æœ€æ–° (æœªè®€)</button>
                        <button class="comment-filter px-4 py-2 rounded-full text-[10px] font-bold tracking-widest border border-uu-sub/30 text-uu-main/40 transition-all hover:border-uu-main" data-filter="all">æ‰€æœ‰ç•™è¨€</button>
                        <button class="comment-filter px-4 py-2 rounded-full text-[10px] font-bold tracking-widest border border-uu-sub/30 text-uu-main/40 transition-all hover:border-uu-main" data-filter="hidden">éš±è—ä¸­</button>
                        <button class="comment-filter px-4 py-2 rounded-full text-[10px] font-bold tracking-widest border border-uu-sub/30 text-uu-main/40 transition-all hover:border-uu-main" data-filter="deleted">å›æ”¶æ¡¶</button>
                    </div>

                    <!-- Comments List -->
                    <div
                        id="comments-list"
                        class="flex-1 space-y-4 overflow-y-auto pr-2 no-scrollbar min-h-[500px]"
                    >
                        <!-- Dynamic Comment Cards -->
                        <div
                            class="flex flex-col items-center justify-center h-full opacity-20 py-20"
                        >
                            <span
                                class="material-symbols-outlined text-6xl mb-4"
                                >history_edu</span
                            >
                            <p
                                class="text-sm font-bold tracking-widest uppercase"
                            >
                                Fetching conversations...
                            </p>
                        </div>
                    </div>
                </section>

                <!-- CONTENT: AUTHOR SETTINGS -->
                <section id="tab-author" class="tab-content hidden w-full flex-1 flex flex-col p-10">
                    <div class="flex items-center justify-between mb-8 pb-6 border-b border-uu-sub/20">
                        <div class="flex items-center gap-3.5">
                            <div class="w-10 h-10 rounded-full bg-uu-sub/10 flex items-center justify-center text-uu-main">
                                <span class="material-symbols-outlined">person_edit</span>
                            </div>
                            <h3 class="font-bold text-xl text-uu-dark">ä½œè€…è¨­å®š</h3>
                        </div>
                        <button id="author-edit-toggle" class="flex items-center gap-2 px-4 py-2 bg-uu-sub/10 text-uu-main rounded-xl text-[10px] font-black tracking-widest uppercase hover:bg-uu-sub/20 transition-all">
                            <span class="material-symbols-outlined text-sm">edit</span>
                            ç·¨è¼¯é—œæ–¼æˆ‘
                        </button>
                    </div>

                    <div id="author-preview" class="space-y-6 animate-fade-in">
                        <div class="flex items-center gap-6 p-6 bg-uu-base/10 rounded-2xl border border-uu-sub/10">
                            <div class="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-sm shrink-0">
                                <img src="/uu-memo.png" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-uu-dark mb-1">é—œæ–¼ç«™é•·</h4>
                                <p class="text-xs text-uu-main/60">ç›®å‰é¡¯ç¤ºæ–¼ã€Œé—œæ–¼æˆ‘ã€é é¢çš„å…§å®¹é è¦½</p>
                            </div>
                        </div>
                        <div id="author-display-content" class="prose prose-sm max-w-none text-uu-main/80 p-8 bg-white rounded-2xl border border-uu-sub/20 min-h-[300px]">
                            <!-- Content will be injected here -->
                        </div>
                    </div>

                    <div id="author-editor" class="hidden space-y-6 animate-fade-in flex-1 flex flex-col">
                        <div class="flex items-center gap-2 px-4 py-3 bg-uu-main/5 rounded-xl border border-uu-main/10 mb-2">
                            <span class="material-symbols-outlined text-uu-main text-sm">info</span>
                            <p class="text-[10px] text-uu-main font-bold">æ­£åœ¨ç·¨è¼¯ï¼šè«‹ä½¿ç”¨ Markdown èªæ³•æ’°å¯«æ‚¨çš„è‡ªæˆ‘ä»‹ç´¹</p>
                        </div>
                        <div class="flex-1 flex flex-col">
                            <textarea
                                id="author-md-editor"
                                class="w-full flex-1 min-h-[500px] bg-uu-base/10 border border-uu-sub/10 rounded-2xl p-8 text-sm font-mono leading-relaxed focus:outline-none focus:bg-white transition-all shadow-inner"
                                placeholder="# é—œæ–¼æˆ‘..."></textarea>
                        </div>
                        <div class="pt-6 mt-4">
                            <div class="flex flex-col gap-3">
                                <PrimaryButton
                                    id="author-save-btn"
                                    text="å„²å­˜è¨­å®š"
                                    showLoader={true}
                                    loaderId="author-save-loader"
                                />
                                <button id="author-cancel-btn" class="text-[10px] font-bold text-uu-main/40 uppercase tracking-[0.2em] hover:text-uu-main transition-all py-2">å–æ¶ˆæ›´è®Š</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CONTENT: SYSTEM -->
                <section id="tab-system" class="tab-content hidden w-full flex-1 flex flex-col p-10">
                    <div class="flex items-center justify-between mb-8 pb-6 border-b border-uu-sub/20">
                        <div class="flex items-center gap-3.5">
                            <div class="w-10 h-10 rounded-full bg-uu-sub/10 flex items-center justify-center text-uu-main">
                                <span class="material-symbols-outlined">payments</span>
                            </div>
                            <h3 class="font-bold text-xl text-uu-dark">å…¨ç«™è¨­å®š</h3>
                        </div>
                        <div class="flex items-center gap-4 bg-uu-base/20 px-5 py-2.5 rounded-2xl border border-uu-sub/10">
                            <span class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">è´ŠåŠ©æ¨¡çµ„ç‹€æ…‹</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="sys-donate-enabled" class="sr-only peer" checked />
                                <div class="w-11 h-6 bg-uu-sub/20 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-uu-sub/30 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-uu-main"></div>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-10">
                        <!-- Donation Config Section -->
                        <div class="bg-white border border-uu-sub/20 rounded-2xl p-8 space-y-8 shadow-sm">
                            <div class="flex items-center gap-3 mb-2 pb-4 border-b border-uu-sub/10">
                                <div class="w-8 h-8 rounded-lg bg-uu-main/5 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-uu-main text-sm">settings_heart</span>
                                </div>
                                <h4 class="text-xs font-black text-uu-dark uppercase tracking-widest">è´ŠåŠ©è©³æƒ…è¨­å®š (Donation Settings)</h4>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-3">
                                    <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest block">Platform Title (å¹³å°åç¨±)</label>
                                    <input
                                        type="text"
                                        id="sys-donate-name"
                                        class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-5 py-4 text-sm focus:outline-none focus:border-uu-main focus:bg-white transition-all shadow-inner"
                                        placeholder="ä¾‹å¦‚ï¼šBuy Me a Coffee"
                                    />
                                </div>
                                <div class="space-y-3">
                                    <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest block">Donation Link (è´ŠåŠ©é€£çµ)</label>
                                    <input
                                        type="text"
                                        id="sys-donate-url"
                                        class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-5 py-4 text-sm focus:outline-none focus:border-uu-main focus:bg-white transition-all shadow-inner"
                                        placeholder="https://..."
                                    />
                                </div>
                            </div>

                            <div class="space-y-3">
                                <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest block">Display Message (é¡¯ç¤ºå…§å®¹)</label>
                                <textarea
                                    id="sys-donate-msg"
                                    class="w-full bg-uu-base/10 border border-uu-sub/10 rounded-2xl p-8 text-sm leading-relaxed focus:outline-none focus:bg-white transition-all min-h-[160px] shadow-inner"
                                    placeholder="è¼¸å…¥æ‚¨æƒ³å°è´ŠåŠ©è€…èªªçš„è©±..."></textarea>
                            </div>
                        </div>

                        <div class="pt-4 mt-4">
                            <PrimaryButton
                                id="save-sys-btn"
                                text="SAVE CONFIGURATION"
                                textId="save-btn-text"
                                showLoader={true}
                                loaderId="save-btn-loader"
                            />
                        </div>

                        <!-- NEW: Build Cleanup Section -->
                        <div class="bg-red-50/50 border border-red-100 rounded-2xl p-8 space-y-4">
                            <div class="flex items-center gap-3 mb-2 pb-4 border-b border-red-100">
                                <div class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-red-600 text-sm">pests</span>
                                </div>
                                <h4 class="text-xs font-black text-red-900 uppercase tracking-widest">æ•…éšœæ’é™¤ï¼šæ¸…é™¤å»ºç½®éŒ¯èª¤ (Emergency Fix)</h4>
                            </div>
                            <p class="text-[10px] text-red-700/70 leading-relaxed font-medium">å¦‚æœåœ¨åŒæ­¥å¾Œ GitHub å»ºç½®å¤±æ•—ï¼Œå¯èƒ½æ˜¯å› ç‚ºæŸäº›è‰ç¨¿æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼ˆä¾‹å¦‚ <code class="bg-red-100 px-1 rounded">test.md</code>ï¼‰ã€‚é»æ“Šä¸‹æ–¹æŒ‰éˆ•å°‡æœƒå¾ GitHub é ç«¯å¼·åˆ¶åˆªé™¤è©²ææ¯€æª”æ¡ˆã€‚</p>
                            <div class="pt-2">
                                <button id="cleanup-build-btn" class="flex items-center gap-2 px-6 py-3 bg-red-600 text-white rounded-xl text-[10px] font-black tracking-widest uppercase hover:bg-red-700 transition-all shadow-lg shadow-red-200">
                                    <span class="material-symbols-outlined text-sm">delete_forever</span>
                                    å¼·åˆ¶åˆªé™¤ test.md ä¸¦ä¿®å¾©å»ºç½®
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <Footer />
</Layout>

<script>
    import { auth, db } from "../../lib/firebase";
    import { onAuthStateChanged } from "firebase/auth";
    import {
        doc,
        getDoc,
        setDoc,
        collection,
        query,
        orderBy,
        onSnapshot,
        updateDoc,
        deleteDoc,
        addDoc,
        serverTimestamp,
    } from "firebase/firestore";
    import { GoogleAuthProvider, signInWithPopup } from "firebase/auth";

    if (typeof window !== "undefined") {
    const GAS_URL =
        "https://script.google.com/macros/s/AKfycbzIF6fuTnS-CPWBMe3UiVd3EtSKtj5CSde6BlPHGPVY6msOGJQupcY4L5QbmPHtKmdeGA/exec";

    const loading = document.getElementById("auth-loading");
    const loginUI = document.getElementById("admin-login-ui");
    const dashboard = document.getElementById("admin-dashboard");
    const emailSpan = document.getElementById("admin-email");
    const adminLoginBtn = document.getElementById("admin-login-btn");
    const unauthorizedMsg = document.getElementById("unauthorized-msg");
    const deniedEmail = document.getElementById("denied-email");

    const imageInput = document.getElementById(
        "image-input"
    ) as HTMLInputElement;
    const imageQueue = document.getElementById("image-queue");

    // --- Tab Logic ---
    const tabBtns = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");

    tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            const tabId = btn.getAttribute("data-tab");

            // Switch Buttons
            tabBtns.forEach((b) => {
                b.classList.remove(
                    "active",
                    "bg-uu-main",
                    "text-white",
                    "shadow-sm"
                );
                b.classList.add(
                    "text-uu-main/60",
                    "hover:bg-uu-sub/10",
                    "hover:text-uu-main"
                );
            });
            btn.classList.add(
                "active",
                "bg-uu-main",
                "text-white",
                "shadow-sm"
            );
            btn.classList.remove(
                "text-uu-main/60",
                "hover:bg-uu-sub/10",
                "hover:text-uu-main"
            );

            // Switch Content
            tabContents.forEach((c) => c.classList.add("hidden"));
            document.getElementById(`tab-${tabId}`)?.classList.remove("hidden");
        });
    });


    // --- Logout ---

    // --- System Settings Firestore Logic ---
    const sysDonateName = document.getElementById(
        "sys-donate-name"
    ) as HTMLInputElement;
    const sysDonateUrl = document.getElementById(
        "sys-donate-url"
    ) as HTMLInputElement;
    const sysDonateMsg = document.getElementById(
        "sys-donate-msg"
    ) as HTMLTextAreaElement;
    const sysDonateEnabled = document.getElementById(
        "sys-donate-enabled"
    ) as HTMLInputElement;
    const saveSysBtn = document.getElementById("save-sys-btn");
    const saveBtnText = document.getElementById("save-btn-text");
    const saveBtnLoader = document.getElementById("save-btn-loader");

    async function fetchSystemConfig() {
        try {
            const docRef = doc(db, "site_config", "donation_settings");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (sysDonateName)
                    sysDonateName.value = data.platform_name || "";
                if (sysDonateUrl) sysDonateUrl.value = data.link_url || "";
                if (sysDonateMsg) sysDonateMsg.value = data.message || "";
                if (sysDonateEnabled)
                    sysDonateEnabled.checked = data.enabled ?? true;
            }
        } catch (err) {
            console.error("Error fetching config:", err);
        }
    }

    saveSysBtn?.addEventListener("click", async () => {
        if (!saveBtnText || !saveBtnLoader) return;

        saveBtnText.textContent = "SAVING...";
        saveBtnLoader.classList.remove("hidden");
        saveSysBtn.setAttribute("disabled", "true");

        try {
            await setDoc(doc(db, "site_config", "donation_settings"), {
                platform_name: sysDonateName.value,
                link_url: sysDonateUrl.value,
                message: sysDonateMsg.value,
                enabled: sysDonateEnabled.checked,
            });

            saveBtnText.textContent = "SAVED SUCCESS!";
            setTimeout(() => {
                saveBtnText.textContent = "SAVE CONFIGURATION";
            }, 2000);
        } catch (err) {
            (window as any).showToast("å„²å­˜å¤±æ•—: " + err, 'error');
        } finally {
            saveBtnLoader.classList.add("hidden");
            saveSysBtn.removeAttribute("disabled");
        }
    });

    // --- Prompt Template Logic (New Firestore Integration) ---
    async function fetchPromptConfig() {
        const templateEl = document.getElementById("draft-template") as HTMLTextAreaElement;
        if (!templateEl) return;
        
        try {
            const docRef = doc(db, "site_config", "prompt_settings");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data.template_content) {
                    templateEl.value = data.template_content;
                    console.log("[System] Prompt template loaded from database.");
                }
            }
        } catch (err) {
            console.error("Error fetching prompt config:", err);
        }
    }

    const saveTemplateBtn = document.getElementById("save-template-btn");
    saveTemplateBtn?.addEventListener("click", async () => {
        const templateEl = document.getElementById("draft-template") as HTMLTextAreaElement;
        if (!templateEl) return;

        if (!confirm("ç¢ºå®šè¦å°‡ç›®å‰çš„å¾®èª¿å…§å®¹å„²å­˜ç‚ºè³‡æ–™åº«çš„ã€é è¨­æ¨¡æ¿ã€å—ï¼Ÿ\nå„²å­˜å¾Œï¼Œæœªä¾†é‡æ–°æ•´ç†é é¢ä¹Ÿæœƒä»¥æ­¤æ¬¡ä¿®æ”¹ç‚ºæº–ã€‚")) return;

        const originalHtml = saveTemplateBtn.innerHTML;
        saveTemplateBtn.innerHTML = `<span class="material-symbols-outlined text-xs animate-spin">sync</span> å„²å­˜ä¸­...`;
        saveTemplateBtn.setAttribute("disabled", "true");

        try {
            await setDoc(doc(db, "site_config", "prompt_settings"), {
                template_content: templateEl.value,
                updated_at: serverTimestamp()
            });
            (window as any).showToast("æ¨¡æ¿å·²æˆåŠŸä¿å­˜è‡³é›²ç«¯", 'success');
        } catch (err) {
            (window as any).showToast("å„²å­˜å¤±æ•—: " + err, 'error');
        } finally {
            saveTemplateBtn.innerHTML = originalHtml;
            saveTemplateBtn.removeAttribute("disabled");
        }
    });


    // --- Author Settings Logic ---
    const authorPreview = document.getElementById("author-preview");
    const authorEditor = document.getElementById("author-editor");
    const authorEditToggle = document.getElementById("author-edit-toggle");
    const authorCancelBtn = document.getElementById("author-cancel-btn");
    const authorSaveBtn = document.getElementById("author-save-btn");
    const authorMdEditor = document.getElementById("author-md-editor") as HTMLTextAreaElement;
    const authorDisplayContent = document.getElementById("author-display-content");
    const authorSaveLoader = document.getElementById("author-save-loader");

    async function fetchAuthorConfig() {
        try {
            const docRef = doc(db, "site_config", "about_me");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (authorMdEditor) authorMdEditor.value = data.content || "";
                if (authorDisplayContent) {
                    authorDisplayContent.innerHTML = data.content ? 
                        data.content.split('\n').map((line: string) => `<p>${line}</p>`).join('') : 
                        '<p class="text-uu-main/30 italic">å°šç„¡å…§å®¹ï¼Œè«‹é»æ“Šç·¨è¼¯...</p>';
                }
            }
        } catch (err) {
            console.error("Error fetching author config:", err);
        }
    }

    authorEditToggle?.addEventListener("click", () => {
        authorPreview?.classList.add("hidden");
        authorEditor?.classList.remove("hidden");
    });

    authorCancelBtn?.addEventListener("click", () => {
        authorEditor?.classList.add("hidden");
        authorPreview?.classList.remove("hidden");
    });

    authorSaveBtn?.addEventListener("click", async () => {
        if (!authorMdEditor || !authorSaveLoader) return;
        
        authorSaveLoader.classList.remove("hidden");
        authorSaveBtn.setAttribute("disabled", "true");

        try {
            await setDoc(doc(db, "site_config", "about_me"), {
                content: authorMdEditor.value,
                updated_at: serverTimestamp()
            });
            
            await fetchAuthorConfig();
            (window as any).showToast("å€‹äººä»‹ç´¹å·²æ›´æ–°", 'success');
            authorEditor?.classList.add("hidden");
            authorPreview?.classList.remove("hidden");
        } catch (err) {
            (window as any).showToast("å„²å­˜å¤±æ•—: " + err, 'error');
        } finally {
            authorSaveLoader.classList.add("hidden");
            authorSaveBtn.removeAttribute("disabled");
        }
    });

    // --- MD Upload & Drag/Drop ---
    const dropzone = document.getElementById("md-dropzone");
    const mdInput = document.getElementById(
        "md-file-input"
    ) as HTMLInputElement;
    const mdEditor = document.getElementById(
        "md-content"
    ) as HTMLTextAreaElement;
    const slugInput = document.getElementById("post-slug") as HTMLInputElement;

    slugInput?.addEventListener("input", (e) => {
        const dateStr = new Date().toISOString().split('T')[0].substring(2).replace(/-/g, '');
        const newSlug = (e.target as HTMLInputElement).value.trim();
        const inputs = document.querySelectorAll('.img-filename-input') as NodeListOf<HTMLInputElement>;
        inputs.forEach(input => {
            const currentVal = input.value;
            const match = currentVal.match(/-(\d+)$/);
            const num = match ? match[1] : '';
            if (newSlug) {
                input.value = num ? `${dateStr}-${newSlug}-${num}` : `${dateStr}-${newSlug}-`;
            } else {
                input.value = num ? `${dateStr}-${num}` : `${dateStr}-`;
            }
        });
    });

    dropzone?.addEventListener("click", () => mdInput.click());
    dropzone?.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("border-uu-main", "bg-uu-main/5");
    });
    dropzone?.addEventListener("dragleave", () => {
        dropzone.classList.remove("border-uu-main", "bg-uu-main/5");
    });
    dropzone?.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("border-uu-main", "bg-uu-main/5");
        const file = e.dataTransfer?.files[0];
        if (file && file.name.endsWith(".md")) handleMd(file);
    });
    mdInput?.addEventListener("change", () => {
        if (mdInput.files?.[0]) handleMd(mdInput.files[0]);
    });

    function handleMd(file: File) {
        const reader = new FileReader();
        reader.onload = (e) => {
            mdEditor.value = e.target?.result as string;
            // Suggest slug
            const base = file.name.replace(".md", "");
            slugInput.value = base.toLowerCase().replace(/\s+/g, "-");
        };
        reader.readAsText(file);
    }

    let processedImages: any[] = [];

    imageInput?.addEventListener("change", async () => {
        const files = imageInput.files;
        if (!files) return;
        for (const file of Array.from(files)) {
            const processed = await processImage(file);
            renderImagePreview(processed, file.name);
        }
    });

    async function processImage(
        file: File
    ): Promise<{ id: string; url: string; type: string; w: number; h: number }> {
        const result = await new Promise<{ id: string; url: string; type: string; w: number; h: number }>((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d")!;
                    
                    const MAX_EDGE = 1600;
                    let tw, th, itype;

                    if (img.width >= img.height) {
                        // Landscape or Square
                        itype = img.width === img.height ? "Square" : "Landscape";
                        if (img.width > MAX_EDGE) {
                            tw = MAX_EDGE;
                            th = (img.height * MAX_EDGE) / img.width;
                        } else {
                            tw = img.width;
                            th = img.height;
                        }
                    } else {
                        // Portrait
                        itype = "Portrait";
                        if (img.height > MAX_EDGE) {
                            th = MAX_EDGE;
                            tw = (img.width * MAX_EDGE) / img.height;
                        } else {
                            tw = img.width;
                            th = img.height;
                        }
                    }

                    canvas.width = tw;
                    canvas.height = th;
                    ctx.drawImage(img, 0, 0, tw, th);

                    resolve({
                        id: Math.random().toString(36).substr(2, 9),
                        url: canvas.toDataURL("image/jpeg", 0.9),
                        type: itype,
                        w: Math.round(tw),
                        h: Math.round(th),
                    });
                };
                img.src = e.target?.result as string;
            };
            reader.readAsDataURL(file);
        });
        processedImages.push(result);
        return result;
    }

    // --- Comments Management Module ---
    const commentsList = document.getElementById("comments-list");
    const commentStats = document.getElementById("comment-stats");
    const filterBtns = document.querySelectorAll(".comment-filter");
    let activeFilter = "latest";
    let allComments: any[] = [];

    function initCommentsModule() {
        const q = query(
            collection(db, "comments"),
            orderBy("created_at", "asc") // Sort by asc so replies appear in order after grouping
        );
 
        onSnapshot(q, async (snapshot) => {
            let fetchedComments = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
            } as any));
            
            // Dynamically fetch latest profiles for verified users (Recognition by UID)
            const userUids = [...new Set(fetchedComments.filter((c: any) => c.author_uid).map((c: any) => c.author_uid))];
            if (userUids.length > 0) {
                try {
                    const userPromises = userUids.map(uid => getDoc(doc(db, "users", uid as string)));
                    const userDocs = await Promise.all(userPromises);
                    const userMap: Record<string, any> = {};
                    userDocs.forEach(d => {
                        if (d.exists()) {
                            userMap[d.id] = d.data();
                        }
                    });
                    
                    // Update fetchedComments with dynamic user details (Strict UID mapping)
                    fetchedComments = fetchedComments.map((c: any) => {
                        const adminUid = 'P9G0w4qEa9gY6ZRY8K8oYVbS7zJ2';
                        
                        // Priority 1: Admin Identity (UID or verified emails)
                        if (c.author_uid === adminUid || c.author_email === 'uu-memo@outlook.com' || c.author_email === 'jing180804@gmail.com') {
                            return {
                                ...c,
                                author_name: 'UU (ç«™é•·)',
                                author_avatar: '/uu-memo.png',
                                is_guest: false
                            };
                        }

                        // Priority 2: Registered User Identity (Mapped by UID)
                        if (c.author_uid && userMap[c.author_uid]) {
                            const latestData = userMap[c.author_uid];
                            return {
                                ...c,
                                author_name: latestData.nickname || c.author_name,
                                author_avatar: latestData.avatar_icon || c.author_avatar,
                                is_guest: false
                            };
                        }
                        
                        return c;
                    });
                } catch (e) {
                    console.error("Failed to fetch latest admin user profiles:", e);
                }
            }
            
            allComments = fetchedComments;

            // Sort local array descending for top-level display, but keep original for nested lookups
            const sortedComments = [...allComments].sort((a,b) => (b.created_at?.seconds || 0) - (a.created_at?.seconds || 0));
            renderComments(sortedComments);
            if (commentStats)
                commentStats.textContent = `${allComments.filter((c: any) => !c.parent_id).length} åŸç”Ÿç•™è¨€`;
        });

 
        filterBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                filterBtns.forEach((b) => {
                    b.classList.remove("active", "bg-white", "text-uu-dark");
                    b.classList.add("text-uu-main/40");
                });
                btn.classList.add("active", "bg-white", "text-uu-dark");
                btn.classList.remove("text-uu-main/40");
                activeFilter = btn.getAttribute("data-filter") || "latest";
                renderComments(allComments);
            });
        });
    }


    function renderComments(comments: any[]) {
        if (!commentsList) return;

        // Separate top-level comments and replies
        const topLevel = comments.filter(c => !c.parent_id);
        const replies = comments.filter(c => c.parent_id);

        const filtered = topLevel.filter((c) => {
            if (activeFilter === "latest") return !c.is_read && !c.is_hidden && !c.is_deleted;
            if (activeFilter === "hidden") return c.is_hidden && !c.is_deleted;
            if (activeFilter === "deleted") return c.is_deleted;
            return !c.is_hidden && !c.is_deleted; // Default view is ALL (includes read/unread, but not hidden/deleted)
        });

        if (filtered.length === 0) {
            commentsList.innerHTML = `<div class="py-20 text-center opacity-30 text-xs font-bold tracking-widest uppercase">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç•™è¨€</div>`;
            return;
        }

        commentsList.innerHTML = filtered
            .map((c) => {
                const date = c.created_at?.toDate ? c.created_at.toDate().toLocaleString() : "å‰›å‰›";
                const belongsTo = c.post_slug || "å…¨ç«™";
                
                // Find replies to this comment
                const myReplies = replies.filter(r => r.parent_id === c.id);

                return `
                <div class="bg-white border border-uu-sub/20 rounded-2xl p-6 transition-all hover:border-uu-main/30 group ${c.is_hidden ? "opacity-60 grayscale" : ""}">
                    <!-- Main Comment Info -->
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-uu-sub/10 flex items-center justify-center overflow-hidden border border-uu-sub/20">
                                ${c.author_avatar && (c.author_avatar.startsWith('http') || c.author_avatar.startsWith('/')) 
                                    ? `<img src="${c.author_avatar}" class="w-full h-full object-cover">` 
                                    : c.author_avatar 
                                        ? `<span class="material-symbols-outlined text-uu-main/40">${c.author_avatar}</span>`
                                        : `<span class="material-symbols-outlined text-uu-main/40">person</span>`
                                }
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-uu-dark flex items-center gap-2">
                                    ${c.author_name || "è¨ªå®¢"}
                                </h4>
                                <p class="text-[10px] text-uu-main/40 font-mono italic">${c.author_email || "æœªæä¾›ä¿¡ç®±"}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-uu-main/30 mb-1 uppercase tracking-tighter">
                                ä¾†è‡ªï¼š<a href="/posts/${c.post_slug}" target="_blank" class="text-uu-main/60 hover:text-uu-main hover:underline decoration-uu-sub/50 underline-offset-2">${belongsTo}</a>
                            </p>
                            <p class="text-[9px] text-uu-main/30">${date}</p>
                        </div>
                    </div>
                    
                    <div class="bg-uu-base/10 rounded-xl p-4 mb-4 text-sm text-uu-main/80 leading-relaxed">
                        ${c.content}
                    </div>

                    <!-- My Replies Section -->
                    ${myReplies.length > 0 ? `
                        <div class="space-y-3 mb-4 mt-2 pl-6 border-l-2 border-uu-sub/20">
                            ${myReplies.map(r => `
                                <div class="bg-uu-main/5 rounded-xl p-4 border border-uu-main/10 relative">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-6 h-6 rounded-full overflow-hidden border border-uu-main/20">
                                            <img src="/uu-memo.png" class="w-full h-full object-cover">
                                        </div>
                                        <div class="flex-1 flex justify-between items-center">
                                            <span class="text-[10px] font-black text-uu-main tracking-wider">UU (ç«™é•·)</span>
                                            <div class="flex items-center gap-4">
                                                <span class="text-[8px] text-uu-main/40 font-mono">${r.created_at?.toDate ? r.created_at.toDate().toLocaleString() : 'å‰›å‰›'}</span>
                                                <button class="action-perm-delete opacity-40 hover:opacity-100 text-uu-main transition-opacity" data-id="${r.id}">
                                                    <span class="material-symbols-outlined text-sm">delete</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-[11px] text-uu-main/80 leading-relaxed">${r.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- Action Bar -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            ${!c.is_read && !c.is_deleted ? `<button class="action-read text-[10px] font-black text-uu-main hover:underline" data-id="${c.id}">æ¨™è¨˜å·²è®€</button>` : ""}
                            <button class="action-hide text-[10px] font-black text-uu-main/40 hover:text-uu-main" data-id="${c.id}">${c.is_hidden ? "å–æ¶ˆéš±è—" : "éš±è—ç•™è¨€"}</button>
                            <button class="action-delete text-[10px] font-black text-uu-main/40 hover:text-uu-main" data-id="${c.id}">${c.is_deleted ? 'æ°¸ä¹…åˆªé™¤' : 'ç§»è‡³å›æ”¶æ¡¶'}</button>
                        </div>
                        <button class="action-reply-toggle flex items-center gap-1.5 px-4 py-1.5 bg-uu-dark text-white rounded-lg text-[10px] font-bold hover:bg-uu-main transition-all" data-id="${c.id}">
                            <span class="material-symbols-outlined text-xs">reply</span>
                            å›è¦†å…§å®¹
                        </button>
                    </div>

                    <!-- Hidden Reply Form -->
                    <div id="reply-form-${c.id}" class="hidden mt-6 pt-6 border-t border-uu-sub/10">
                        <div class="space-y-3">
                            <label class="text-[9px] font-bold text-uu-main/40 uppercase tracking-widest">ç®¡ç†å“¡å›è¦†</label>
                            <textarea class="reply-textarea w-full bg-white border border-uu-sub/30 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all h-24 shadow-inner" placeholder="è¼¸å…¥å›è¦†å…§å®¹..."></textarea>
                            <div class="flex justify-end gap-2">
                                <button class="cancel-reply text-[10px] font-bold text-uu-main/40 hover:text-uu-dark" data-id="${c.id}">å–æ¶ˆ</button>
                                <button class="send-reply bg-uu-main text-white px-5 py-2 rounded-lg text-[10px] font-black tracking-widest uppercase hover:bg-uu-dark transition-all" data-id="${c.id}" data-slug="${c.post_slug}">ç™¼é€å›è¦†</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join("");



        // Attach Event Listeners
        commentsList.querySelectorAll(".action-read").forEach((btn) => {
            btn.addEventListener("click", () => markAsRead(btn.getAttribute("data-id")!));
        });
        commentsList.querySelectorAll(".action-hide").forEach((btn) => {
            btn.addEventListener("click", () =>
                toggleCommentVisibility(btn.getAttribute("data-id")!, true)
            );
        });
        commentsList.querySelectorAll(".action-unhide").forEach((btn) => {
            btn.addEventListener("click", () =>
                toggleCommentVisibility(btn.getAttribute("data-id")!, false)
            );
        });
        commentsList.querySelectorAll(".action-delete").forEach((btn) => {
            btn.addEventListener("click", () =>
                destructiveAction(btn.getAttribute("data-id")!)
            );
        });

        // Specific Permanent Delete for nested replies
        commentsList.querySelectorAll(".action-perm-delete").forEach((btn) => {
            btn.addEventListener("click", () => {
                if(confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤æ¢å›è¦†ï¼Ÿ")) {
                    deleteDoc(doc(db, "comments", btn.getAttribute("data-id")!));
                }
            });
        });

        // Reply UI Toggle
        commentsList.querySelectorAll(".action-reply-toggle").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.getAttribute("data-id");
                const form = document.getElementById(`reply-form-${id}`);
                form?.classList.toggle("hidden");
            });
        });

        commentsList.querySelectorAll(".cancel-reply").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.getAttribute("data-id");
                const form = document.getElementById(`reply-form-${id}`);
                form?.classList.add("hidden");
            });
        });

        commentsList.querySelectorAll(".send-reply").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.getAttribute("data-id");
                const slug = btn.getAttribute("data-slug");
                const textarea = document.querySelector(`#reply-form-${id} textarea`) as HTMLTextAreaElement;
                if (textarea.value.trim()) {
                    submitReply(id!, slug!, textarea.value);
                }
            });
        });
    }

    async function markAsRead(id: string) {
        try {
            await updateDoc(doc(db, "comments", id), { is_read: true });
        } catch (e) { console.error(e); }
    }

    async function toggleCommentVisibility(id: string, hide: boolean) {
        try {
            await updateDoc(doc(db, "comments", id), { is_hidden: hide });
        } catch (e) {
            (window as any).showToast("æ“ä½œå¤±æ•—: " + e, 'error');
        }
    }

    async function destructiveAction(id: string) {
        const comment = allComments.find(c => c.id === id);
        if (!comment) return;

        if (comment.is_deleted) {
            // Permanent Delete
            if (!confirm("ç¢ºå®šè¦å°‡é€™æ¢ç•™è¨€å¾è³‡æ–™åº«å¾¹åº•ç§»é™¤å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚")) return;
            try {
                await deleteDoc(doc(db, "comments", id));
            } catch (e) { (window as any).showToast("åˆªé™¤å¤±æ•—: " + e, 'error'); }
        } else {
            // Move to Trash
            if (!confirm("å°‡æ­¤ç•™è¨€ç§»è‡³å›æ”¶æ¡¶ï¼Ÿ")) return;
            try {
                await updateDoc(doc(db, "comments", id), { is_deleted: true });
            } catch (e) { (window as any).showToast("ç§»å‹•å¤±æ•—: " + e, 'error'); }
        }
    }

    async function submitReply(parentId: string, postSlug: string, content: string) {
        try {
            await addDoc(collection(db, "comments"), {
                author_uid: auth.currentUser?.uid || "admin", // Dynamic Admin UID
                author_name: "UU (ç«™é•·)",
                author_email: "uu-memo@outlook.com",
                author_avatar: "/uu-memo.png",
                content: content,
                post_slug: postSlug,
                parent_id: parentId, // Links to original comment
                is_hidden: false,
                is_deleted: false,
                is_read: true,
                is_guest: false,
                created_at: serverTimestamp()
            });
            // Mark original as read
            await markAsRead(parentId);
            (window as any).showToast("å›è¦†å·²ç™¼é€", 'success');
            const form = document.getElementById(`reply-form-${parentId}`);
            form?.classList.add("hidden");
        } catch (e) {
            (window as any).showToast("ç™¼é€å¤±æ•—: " + e, 'error');
        }
    }


    function renderImagePreview(
        data: { url: string; type: string; w: number; h: number, id: string },
        name: string
    ) {
        if (!imageQueue) return;
        const card = document.createElement("div");
        card.id = `img-card-${data.id}`;
        card.className =
            "bg-white border border-uu-sub/20 rounded-2xl p-4 flex gap-4 items-start group relative";

        // Use aspect ratio based on type
        let aspect = "aspect-auto";
        if (data.type === "Landscape") aspect = "aspect-video"; 
        if (data.type === "Portrait") aspect = "aspect-[3/4]";
        if (data.type === "Square") aspect = "aspect-square";

        const dateStr = new Date().toISOString().split('T')[0].substring(2).replace(/-/g, '');
        const currentSlug = slugInput?.value.trim() || "";
        const prefix = currentSlug ? `${dateStr}-${currentSlug}-` : `${dateStr}-`;

        card.innerHTML = `
            <div class="w-16 ${aspect} rounded-lg overflow-hidden bg-uu-sub/10 flex-shrink-0 border border-uu-sub/10">
                <img src="${data.url}" class="w-full h-full object-cover" />
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-[9px] font-black bg-uu-main/10 text-uu-main px-1.5 py-0.5 rounded">${data.type}</span>
                    <span class="text-[9px] text-uu-main/40 uppercase font-mono">${data.w} Ã— ${data.h}</span>
                </div>
                <p class="text-[10px] font-bold text-uu-dark truncate mb-2">${name}</p>
                <input type="text" data-id="${data.id}" placeholder="${dateStr}-slug-01" value="${prefix}" class="img-filename-input w-full bg-uu-base/10 shadow-inner border shadow-sm border-uu-sub/30 rounded-lg px-2 py-1.5 text-[11px] font-mono focus:outline-none focus:ring-1 focus:ring-uu-main/50 transition-all font-bold text-uu-dark" />
            </div>
            <button class="absolute top-2 right-2 text-uu-main/20 hover:text-uu-dark opacity-0 group-hover:opacity-100 transition-opacity" onclick="removeImage('${data.id}')">
                <span class="material-symbols-outlined text-sm">close</span>
            </button>
        `;
        imageQueue.appendChild(card);
    }

    (window as any).removeImage = (id: string) => {
        processedImages = processedImages.filter(img => img.id !== id);
        document.getElementById(`img-card-${id}`)?.remove();
    };

    // --- Sync to GitHub Logic ---
    const finalPushBtn = document.getElementById("final-push-btn");

    finalPushBtn?.addEventListener("click", async () => {
        const slug = slugInput.value.trim();
        const content = mdEditor.value.trim();
        const status = (document.getElementById("post-status") as HTMLSelectElement).value;

        if (!slug || !content) {
            (window as any).showToast("è«‹å¡«å¯« Slug èˆ‡ æ–‡ç« å…§å®¹", 'info');
            return;
        }

        if (!confirm("ç¢ºå®šè¦å°‡æ–‡ç« èˆ‡åœ–ç‰‡åŒæ­¥è‡³ GitHub å—ï¼Ÿ")) return;

        (window as any).showToast("æ­£åœ¨å»ºç«‹åŒæ­¥è«‹æ±‚...", 'info');

        const btnText = finalPushBtn.querySelector('span:not(.material-symbols-outlined)');
        const btnIcon = finalPushBtn.querySelector('.material-symbols-outlined');
        const originalText = btnText?.textContent || "";
        
        if (btnText) btnText.textContent = "SYNCING...";
        finalPushBtn.setAttribute("disabled", "true");

        try {
            const files = [];
            
            // 1. æº–å‚™ Markdown æ–‡ç« 
            const fileName = `${slug}.md`;
            const filePath = `src/content/posts/${fileName}`;
            files.push({
                path: filePath,
                content: btoa(unescape(encodeURIComponent(content)))
            });

            // 2. æº–å‚™åœ–ç‰‡
            const datePath = new Date().toISOString().split('T')[0].substring(2, 4) + new Date().toISOString().split('T')[0].substring(5, 7);
            for (const img of processedImages) {
                const imgInput = document.querySelector(`.img-filename-input[data-id="${img.id}"]`) as HTMLInputElement;
                let finalName = imgInput?.value.trim() || img.id;
                if (!finalName.includes('.')) finalName += ".jpg";
                
                const imgPath = `public/images/${datePath}/${finalName}`;
                files.push({
                    path: imgPath,
                    content: img.url.split(',')[1]
                });
            }

            // 3. ç™¼èµ·æ‰¹æ¬¡åŒæ­¥è«‹æ±‚ (å–®æ¬¡ Commit)
            console.log("[Sync] Batch uploading files:", files.map(f => f.path));
            
            const syncResponse = await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({
                    action: "batch_upload",
                    files: files,
                    message: `Admin: Sync "${slug}" (${files.length} files)`,
                    branch: "main"
                })
            });

            (window as any).showToast(`æˆåŠŸï¼å·²å°‡ ${files.length} å€‹æª”æ¡ˆçµ±æ•´ç‚ºä¸€æ¬¡æäº¤åŒæ­¥ã€‚`, 'success', 5000);
        } catch (err) {
            console.error("[Sync] Error:", err);
            (window as any).showToast("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·šæˆ– GAS è¨­å®šã€‚", 'error');
        } finally {
            if (btnText) btnText.textContent = originalText;
            finalPushBtn.removeAttribute("disabled");
        }
    });

    // --- Cleanup Build Logic ---
    const cleanupBtn = document.getElementById("cleanup-build-btn");
    cleanupBtn?.addEventListener("click", async () => {
        if (!confirm("ç¢ºå®šè¦å¾ GitHub åˆªé™¤ src/content/posts/test.md å—ï¼Ÿé€™é€šå¸¸ç”¨æ–¼ä¿®å¾©å»ºç½®å¤±æ•—ã€‚")) return;
        
        const originalContent = cleanupBtn.innerHTML;
        cleanupBtn.innerHTML = `<span class="material-symbols-outlined text-sm animate-spin">sync</span> æ¸…ç†ä¸­...`;
        cleanupBtn.setAttribute("disabled", "true");

        try {
            await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({
                    action: "delete_file",
                    path: "src/content/posts/test.md",
                    message: "Admin: Emergency cleanup of corrupted test.md",
                    branch: "main"
                })
            });
            (window as any).showToast("æ¸…ç†è«‹æ±‚å·²é€å‡ºï¼å»ºç½®æ‡‰æœƒåœ¨å¹¾åˆ†é˜å¾Œæ¢å¾©æ­£å¸¸ã€‚", 'success');
        } catch (err) {
            (window as any).showToast("æ¸…ç†å¤±æ•—", 'error');
        } finally {
            cleanupBtn.innerHTML = originalContent;
            cleanupBtn.removeAttribute("disabled");
        }
    });

    // --- Seeding Logic ---
    const seedBtn = document.getElementById("seed-comments-btn");
    seedBtn?.addEventListener("click", async () => {
        if (!confirm("Add 3 test comments to Firestore?")) return;

        const testData = [
            {
                author_name: "å°æ—",
                author_email: "lin@example.com",
                content:
                    "é€™ç¯‡æ–‡ç« å¯«å¾—å¾ˆæœ‰æº«åº¦ï¼Œåœ–ç‰‡çš„è‰²èª¿ä¹Ÿé…å¾—å¾ˆå®‰éœã€‚æœŸå¾…æ›´å¤šçš„åˆ†äº«ï¼",
                post_slug: "2024-spring-trip",
                is_hidden: false,
                is_deleted: false,
                is_read: false,
                created_at: serverTimestamp(),
            },
            {
                author_name: "Art Explorer",
                author_email: "art@travel.io",
                content:
                    "é—œæ–¼è† å·æ”å½±çš„é‚£ä¸€æ®µå¾ˆæœ‰åŒæ„Ÿï¼Œé‚£ç¨®ç­‰å¾…æ²–æ´—çš„ä¸ç¢ºå®šæ„Ÿæ‰æ˜¯æœ€è¿·äººçš„åœ°æ–¹ã€‚",
                post_slug: "film-photography-essence",
                is_hidden: true,
                is_deleted: false,
                is_read: false,
                created_at: serverTimestamp(),
            },
            {
                author_name: "åŒ¿åè¨ªå®¢",
                author_email: "",
                content: "è«‹å•é€™å¼µç…§ç‰‡æ˜¯åœ¨å“ªè£¡æ‹çš„ï¼Ÿæ§‹åœ–å¥½ç¾ï¼",
                post_slug: "kyoto-morning-walk",
                is_hidden: false,
                is_deleted: false,
                is_read: true,
                created_at: serverTimestamp(),
            },
        ];

        try {
            for (const item of testData) {
                await addDoc(collection(db, "comments"), item);
            }
            alert("Test data seeded successfully!");
        } catch (e) {
            alert("Seeding failed: " + e);
        }
    });

    // --- Logic for Login Button ---
    adminLoginBtn?.addEventListener("click", async () => {
        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
        } catch (err: any) {
            alert("Login Failed: " + err.message);
        }
    });

    // --- Authentication & Initialization Execution ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            // No User -> Show Login UI
            loading?.classList.add("opacity-0");
            setTimeout(() => {
                loading?.classList.add("hidden");
                loginUI?.classList.remove("hidden");
                dashboard?.classList.add("hidden");
            }, 300);
            return;
        }

        // We have a user, now verify permission (Admin Trap)
        console.log("[Auth] User detected:", user.email);
        
        try {
            const credentialRef = doc(db, "admin_vault", "credentials");
            await getDoc(credentialRef); // Permission trap
            
            // Access Granted
            console.log("[System] Admin Verified.");
            if (emailSpan) emailSpan.textContent = user.email;

            // Fetch Data
            fetchSystemConfig();
            fetchAuthorConfig();
            fetchPromptConfig();
            initCommentsModule();

            // Transition UI
            loading?.classList.add("opacity-0");
            loginUI?.classList.add("hidden");
            setTimeout(() => {
                loading?.classList.add("hidden");
                dashboard?.classList.remove("hidden");
                dashboard?.classList.add("opacity-100");
            }, 300);

        } catch (err: any) {
            // Access Denied (Logged in but no permission)
            console.error("[Auth] Access Denied for", user.email, ":", err.code);
            
            if (deniedEmail) deniedEmail.textContent = user.email || "Unknown Account";
            unauthorizedMsg?.classList.remove("hidden");
            
            loading?.classList.add("opacity-0");
            setTimeout(() => {
                loading?.classList.add("hidden");
                loginUI?.classList.remove("hidden");
            }, 300);
        }
    });

    document.getElementById("logout-btn")?.addEventListener("click", () => {
        auth.signOut();
        window.location.reload();
    });
    }
    // --- Draft Tool Logic ---
    const initDraftTool = () => {
        const generateDraftBtn = document.getElementById("generate-draft-btn");
        const copyPromptBtn = document.getElementById("copy-prompt-btn");
        const draftResultContainer = document.getElementById("draft-result-container");
        const draftResultArea = document.getElementById("draft-result") as HTMLTextAreaElement;

        generateDraftBtn?.addEventListener("click", () => {
            const q1 = (document.getElementById("draft-q1") as HTMLInputElement).value || "[æœªå¡«å¯«]";
            const q2 = (document.getElementById("draft-q2") as HTMLInputElement).value || "[æœªå¡«å¯«]";
            const q3 = (document.getElementById("draft-q3") as HTMLInputElement).value || "[æœªå¡«å¯«]";
            const q4 = (document.getElementById("draft-q4") as HTMLTextAreaElement).value || "[æœªå¡«å¯«]";
            const q5 = (document.getElementById("draft-q5") as HTMLTextAreaElement).value || "[æœªå¡«å¯«]";
            const q6 = (document.getElementById("draft-q6") as HTMLInputElement).value || "è¼•é¬†å¹½é»˜çš„å€‹äººéš¨ç­†";
            const slug = (document.getElementById("draft-slug") as HTMLInputElement).value || "your-slug";
            const cat = (document.getElementById("draft-cat") as HTMLInputElement).value || "";
            const tags = (document.getElementById("draft-tags") as HTMLInputElement).value || "";

            const today = new Date().toISOString().split('T')[0];
            const datePath = today.substring(2, 4) + today.substring(5, 7); // YYMM
            
            // Handle Tags Logic (Dynamic Expansion if < 5)
            let tagsOutput = "æˆ‘å›ç­”çš„æ¨™ç±¤ï¼Œç„¡å‰‡ä½ è² è²¬ç”Ÿæˆï¼Œè‡³å°‘ 6 å€‹";
            if (tags.trim()) {
                const tagsArr = tags.split(',').map(t => t.trim()).filter(t => t);
                if (tagsArr.length > 0 && tagsArr.length < 5) {
                    tagsOutput = `${tagsArr.join(', ')}ï¼Œè«‹ä»¥æ­¤ç‚ºåŸºç¤æ“´å¢åˆ°è‡³å°‘ 6 å€‹ä»¥ä¸Š`;
                } else if (tagsArr.length >= 5) {
                    tagsOutput = tagsArr.join(', ');
                }
            }

            // Get template string
            const templateEl = document.getElementById("draft-template") as HTMLTextAreaElement;
            let prompt = templateEl ? templateEl.value : "";
            
            // Format q4 to handle line breaks properly if not empty
            const formattedQ4 = q4 !== "[æœªå¡«å¯«]" 
                ? q4.split('\n').filter(l => l.trim()).map(line => `   ${line.trim().startsWith('-') ? '' : '- '}${line}`).join('\n')
                : q4;

            // Replace variables placeholders with actual values
            prompt = prompt.replace(/\{\{q1\}\}/g, q1)
                           .replace(/\{\{q2\}\}/g, q2)
                           .replace(/\{\{q3\}\}/g, q3)
                           .replace(/\{\{q4\}\}/g, formattedQ4)
                           .replace(/\{\{q5\}\}/g, q5)
                           .replace(/\{\{q6\}\}/g, q6)
                           .replace(/\{\{slug\}\}/g, slug)
                           .replace(/\{\{cat\}\}/g, cat || 'æˆ‘å›ç­”çš„åˆ†é¡ï¼Œç„¡å‰‡ä½ è² è²¬ç”Ÿæˆ')
                           .replace(/\{\{tags\}\}/g, tagsOutput)
                           .replace(/\{\{date\}\}/g, today)
                           .replace(/\{\{datePath\}\}/g, datePath);

            if (draftResultArea) draftResultArea.value = prompt;
            draftResultContainer?.classList.remove("hidden");
            draftResultContainer?.scrollIntoView({ behavior: 'smooth' });
        });

        copyPromptBtn?.addEventListener("click", () => {
            if (draftResultArea) {
                draftResultArea.select();
                document.execCommand("copy");
                const originalText = copyPromptBtn.innerHTML;
                copyPromptBtn.innerHTML = `<span class="material-symbols-outlined text-sm">done</span> å·²è¤‡è£½`;
                setTimeout(() => {
                    copyPromptBtn.innerHTML = originalText;
                }, 2000);
            }
        });
    };

    if (typeof window !== 'undefined') {
        initDraftTool();
    }
</script>

<style>
    /* Reuse User Dashboard Styles */
    .dashboard-layout {
        display: grid;
        grid-template-columns: 288px minmax(0, 1fr);
        gap: 2.5rem;
        align-items: start;
        width: 100%;
    }
    .dashboard-sidebar {
        width: 288px;
        position: sticky;
        top: 6rem;
    }
    .dashboard-content {
        min-width: 0;
        width: 100%;
        overflow: hidden;
    }

    /* Mobile Responsive */
    @media (max-width: 767px) {
        .dashboard-layout {
            display: flex;
            flex-direction: column;
        }
        .dashboard-sidebar {
            width: 100%;
            position: static;
        }
    }

    /* Scrollbar for editor */
    #md-content::-webkit-scrollbar {
        width: 6px;
    }
    #md-content::-webkit-scrollbar-thumb {
        background: rgba(26, 26, 26, 0.1);
        border-radius: 10px;
    }
</style>
