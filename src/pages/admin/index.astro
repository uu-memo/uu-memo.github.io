---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import PrimaryButton from "../../components/PrimaryButton.astro";
---

<Layout title="Admin Management | UU MEMO">
    <Header />

    <main
        class="max-w-6xl mx-auto px-6 py-12 md:py-20 min-h-[85vh] flex flex-col w-full self-stretch"
    >
        <!-- Auth Loading (Same as User Page) -->
        <div
            id="auth-loading"
            class="fixed inset-0 z-[60] bg-uu-base flex flex-col items-center justify-center space-y-4 transition-opacity duration-300"
        >
            <div
                class="w-12 h-12 border-4 border-uu-sub border-t-uu-main rounded-full animate-spin"
            >
            </div>
            <p
                class="text-uu-main/60 tracking-widest text-sm font-medium uppercase"
            >
                Verifying Credentials...
            </p>
        </div>

        <!-- Admin Dashboard Container (Exact Mirror of User Dashboard Layout) -->
        <div
            id="admin-dashboard"
            class="hidden opacity-0 transition-opacity duration-500 dashboard-layout w-full"
        >
            <!-- LEFT COLUMN: Sidebar -->
            <aside class="dashboard-sidebar">
                <div
                    class="bg-uu-light p-8 rounded-2xl border border-uu-sub/30 shadow-sm flex flex-col items-center text-center"
                >
                    <div
                        class="w-20 h-20 bg-uu-main/10 rounded-full flex items-center justify-center overflow-hidden border-4 border-white shadow-sm mb-4 shrink-0"
                    >
                        <span
                            class="material-symbols-outlined text-uu-main text-4xl"
                            >admin_panel_settings</span
                        >
                    </div>

                    <div class="w-full">
                        <h1
                            class="text-lg font-bold font-logo text-uu-dark mb-0.5 truncate px-2"
                        >
                            ADMINISTRATOR
                        </h1>
                        <p
                            id="admin-email"
                            class="text-[10px] text-uu-main/60 tracking-wider font-mono truncate px-2"
                        >
                        </p>
                    </div>

                    <div
                        class="w-8 h-0.5 bg-uu-sub/20 rounded-full my-6 shrink-0"
                    >
                    </div>

                    <nav class="w-full flex flex-col gap-1.5">
                        <button
                            class="tab-btn active group flex items-center gap-3.5 px-4 py-3 rounded-xl transition-all w-full bg-uu-main text-white shadow-sm text-left"
                            data-tab="editor"
                        >
                            <span class="material-symbols-outlined text-xl"
                                >edit_note</span
                            >
                            <span
                                class="text-sm font-bold tracking-widest leading-none"
                                >文章編輯</span
                            >
                        </button>
                        <button
                            class="tab-btn group flex items-center gap-3.5 px-4 py-3 rounded-xl transition-all w-full text-uu-main/60 hover:bg-uu-sub/10 hover:text-uu-main text-left"
                            data-tab="comments"
                        >
                            <span class="material-symbols-outlined text-xl"
                                >forum</span
                            >
                            <span
                                class="text-sm font-bold tracking-widest leading-none"
                                >留言管理</span
                            >
                        </button>
                        <button
                            class="tab-btn group flex items-center gap-3.5 px-4 py-3 rounded-xl transition-all w-full text-uu-main/60 hover:bg-uu-sub/10 hover:text-uu-main text-left"
                            data-tab="author"
                        >
                            <span class="material-symbols-outlined text-xl"
                                >person_edit</span
                            >
                            <span
                                class="text-sm font-bold tracking-widest leading-none"
                                >作者設定</span
                            >
                        </button>
                        <button
                            class="tab-btn group flex items-center gap-3.5 px-4 py-3 rounded-xl transition-all w-full text-uu-main/60 hover:bg-uu-sub/10 hover:text-uu-main text-left"
                            data-tab="system"
                        >
                            <span class="material-symbols-outlined text-xl"
                                >tune</span
                            >
                            <span
                                class="text-sm font-bold tracking-widest leading-none"
                                >全站設定</span
                            >
                        </button>

                        <div class="h-2"></div>

                        <button
                            id="logout-btn"
                            class="w-full flex items-center gap-3.5 px-4 py-3 rounded-xl text-uu-main/40 hover:text-uu-main hover:bg-uu-sub/10 transition-all group border border-transparent hover:border-uu-sub/20 text-left mt-2 cursor-pointer"
                        >
                            <span class="material-symbols-outlined text-xl"
                                >logout</span
                            >
                            <span
                                class="text-sm font-bold tracking-widest leading-none"
                                >登出</span
                            >
                        </button>
                    </nav>
                </div>
            </aside>

            <!-- RIGHT COLUMN: Content -->
            <div
                class="dashboard-content bg-uu-light rounded-2xl border border-uu-sub/30 shadow-sm min-h-[700px] flex flex-col overflow-hidden"
            >
                <!-- CONTENT: EDITOR -->
                <section
                    id="tab-editor"
                    class="tab-content w-full flex-1 flex flex-col p-10"
                >
                    <div
                        class="flex items-center gap-3.5 mb-8 pb-6 border-b border-uu-sub/20"
                    >
                        <div
                            class="w-10 h-10 rounded-full bg-uu-sub/10 flex items-center justify-center text-uu-main"
                        >
                            <span class="material-symbols-outlined"
                                >description</span
                            >
                        </div>
                        <h3 class="font-bold text-xl text-uu-dark">內容創作</h3>
                    </div>

                    <div class="space-y-8 flex-1">
                        <!-- Top Meta -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest"
                                    >Article Slug</label
                                >
                                <input
                                    id="post-slug"
                                    type="text"
                                    class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all"
                                    placeholder="例如: 2024-spring-trip"
                                />
                            </div>
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest"
                                    >Visibility</label
                                >
                                <div class="relative">
                                    <select
                                        id="post-status"
                                        class="w-full appearance-none bg-uu-base/20 border border-uu-sub/20 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all pr-10"
                                    >
                                        <option value="public"
                                            >立即發佈 (Public)</option
                                        >
                                        <option value="private"
                                            >私密閱讀 (Private)</option
                                        >
                                    </select>
                                    <span
                                        class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-uu-main/40 pointer-events-none"
                                        >expand_more</span
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Markdown Upload Dropzone -->
                        <div
                            id="md-dropzone"
                            class="border-2 border-dashed border-uu-sub/30 rounded-2xl py-12 flex flex-col items-center justify-center gap-3 transition-colors hover:border-uu-main/50 hover:bg-uu-sub/5 group cursor-pointer"
                        >
                            <input
                                type="file"
                                id="md-file-input"
                                accept=".md"
                                class="hidden"
                            />
                            <span
                                class="material-symbols-outlined text-4xl text-uu-main/30 group-hover:text-uu-main transition-colors"
                                >cloud_upload</span
                            >
                            <div class="text-center">
                                <p class="text-xs font-bold text-uu-main/60">
                                    拖移 .md 檔案至此，或點擊選擇
                                </p>
                                <p
                                    class="text-[10px] text-uu-main/30 mt-1 italic"
                                >
                                    系統將自動讀取內容並嘗試生成 Slug
                                </p>
                            </div>
                        </div>

                        <!-- Editor -->
                        <div class="space-y-2 flex-1 flex flex-col">
                            <label
                                class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest"
                                >Markdown Editor</label
                            >
                            <textarea
                                id="md-content"
                                class="w-full flex-1 min-h-[500px] bg-uu-base/10 border border-uu-sub/10 rounded-2xl p-8 text-sm font-mono leading-relaxed focus:outline-none focus:bg-white transition-all shadow-inner"
                                placeholder="# 標題..."></textarea>
                        </div>

                        <!-- Image Workshop -->
                        <div class="space-y-6 pt-6 border-t border-uu-sub/20">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span
                                        class="material-symbols-outlined text-uu-main"
                                        >image</span
                                    >
                                    <h4 class="font-bold text-sm text-uu-dark">
                                        影像工坊
                                    </h4>
                                </div>
                                <input
                                    type="file"
                                    id="image-input"
                                    multiple
                                    accept="image/*"
                                    class="hidden"
                                />
                                <button
                                    onclick="document.getElementById('image-input').click()"
                                    class="px-4 py-2 bg-uu-dark text-white rounded-lg text-[10px] font-black tracking-widest uppercase hover:bg-uu-main transition-all active:scale-95"
                                    >批次上傳照片</button
                                >
                            </div>

                            <div
                                id="image-queue"
                                class="grid grid-cols-1 sm:grid-cols-2 gap-4"
                            >
                                <!-- Dynamic Preview Cards -->
                            </div>
                        </div>

                        <div class="pt-8">
                            <PrimaryButton 
                                id="final-push-btn" 
                                text="SYNC TO GITHUB" 
                                icon="send"
                            />
                        </div>
                    </div>
                </section>

                <!-- CONTENT: COMMENTS -->
                <section
                    id="tab-comments"
                    class="tab-content hidden w-full flex-1 flex flex-col p-10"
                >
                    <div
                        class="flex items-center justify-between mb-8 pb-6 border-b border-uu-sub/20"
                    >
                        <div class="flex items-center gap-3.5">
                            <div
                                class="w-10 h-10 rounded-full bg-uu-sub/10 flex items-center justify-center text-uu-main"
                            >
                                <span class="material-symbols-outlined"
                                    >forum</span
                                >
                            </div>
                            <h3 class="font-bold text-xl text-uu-dark">
                                留言管理
                            </h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <button
                                id="seed-comments-btn"
                                class="px-3 py-1.5 border border-uu-sub/30 rounded-full text-[9px] font-black text-uu-main/40 hover:bg-uu-main hover:text-white transition-all uppercase tracking-widest"
                                >Seed Test Data</button
                            >
                            <div
                                id="comment-stats"
                                class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest bg-uu-base/50 px-3 py-1.5 rounded-full border border-uu-sub/20"
                            >
                                Loading...
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="flex gap-2 mb-6">
                        <button class="comment-filter active px-4 py-2 rounded-full text-[10px] font-bold tracking-widest border border-uu-sub/30 bg-white text-uu-dark transition-all hover:border-uu-main" data-filter="latest">最新 (未讀)</button>
                        <button class="comment-filter px-4 py-2 rounded-full text-[10px] font-bold tracking-widest border border-uu-sub/30 text-uu-main/40 transition-all hover:border-uu-main" data-filter="all">所有留言</button>
                        <button class="comment-filter px-4 py-2 rounded-full text-[10px] font-bold tracking-widest border border-uu-sub/30 text-uu-main/40 transition-all hover:border-uu-main" data-filter="hidden">隱藏中</button>
                        <button class="comment-filter px-4 py-2 rounded-full text-[10px] font-bold tracking-widest border border-uu-sub/30 text-uu-main/40 transition-all hover:border-uu-main" data-filter="deleted">回收桶</button>
                    </div>

                    <!-- Comments List -->
                    <div
                        id="comments-list"
                        class="flex-1 space-y-4 overflow-y-auto pr-2 no-scrollbar min-h-[500px]"
                    >
                        <!-- Dynamic Comment Cards -->
                        <div
                            class="flex flex-col items-center justify-center h-full opacity-20 py-20"
                        >
                            <span
                                class="material-symbols-outlined text-6xl mb-4"
                                >history_edu</span
                            >
                            <p
                                class="text-sm font-bold tracking-widest uppercase"
                            >
                                Fetching conversations...
                            </p>
                        </div>
                    </div>
                </section>

                <!-- CONTENT: AUTHOR SETTINGS -->
                <section id="tab-author" class="tab-content hidden w-full flex-1 flex flex-col p-10">
                    <div class="flex items-center justify-between mb-8 pb-6 border-b border-uu-sub/20">
                        <div class="flex items-center gap-3.5">
                            <div class="w-10 h-10 rounded-full bg-uu-sub/10 flex items-center justify-center text-uu-main">
                                <span class="material-symbols-outlined">person_edit</span>
                            </div>
                            <h3 class="font-bold text-xl text-uu-dark">作者設定</h3>
                        </div>
                        <button id="author-edit-toggle" class="flex items-center gap-2 px-4 py-2 bg-uu-sub/10 text-uu-main rounded-xl text-[10px] font-black tracking-widest uppercase hover:bg-uu-sub/20 transition-all">
                            <span class="material-symbols-outlined text-sm">edit</span>
                            編輯關於我
                        </button>
                    </div>

                    <div id="author-preview" class="space-y-6 animate-fade-in">
                        <div class="flex items-center gap-6 p-6 bg-uu-base/10 rounded-2xl border border-uu-sub/10">
                            <div class="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-sm shrink-0">
                                <img src="/uu-memo.png" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-uu-dark mb-1">關於站長</h4>
                                <p class="text-xs text-uu-main/60">目前顯示於「關於我」頁面的內容預覽</p>
                            </div>
                        </div>
                        <div id="author-display-content" class="prose prose-sm max-w-none text-uu-main/80 p-8 bg-white rounded-2xl border border-uu-sub/20 min-h-[300px]">
                            <!-- Content will be injected here -->
                        </div>
                    </div>

                    <div id="author-editor" class="hidden space-y-6 animate-fade-in flex-1 flex flex-col">
                        <div class="flex items-center gap-2 px-4 py-3 bg-uu-main/5 rounded-xl border border-uu-main/10 mb-2">
                            <span class="material-symbols-outlined text-uu-main text-sm">info</span>
                            <p class="text-[10px] text-uu-main font-bold">正在編輯：請使用 Markdown 語法撰寫您的自我介紹</p>
                        </div>
                        <div class="flex-1 flex flex-col">
                            <textarea
                                id="author-md-editor"
                                class="w-full flex-1 min-h-[500px] bg-uu-base/10 border border-uu-sub/10 rounded-2xl p-8 text-sm font-mono leading-relaxed focus:outline-none focus:bg-white transition-all shadow-inner"
                                placeholder="# 關於我..."></textarea>
                        </div>
                        <div class="pt-6 mt-4">
                            <div class="flex flex-col gap-3">
                                <PrimaryButton
                                    id="author-save-btn"
                                    text="儲存設定"
                                    showLoader={true}
                                    loaderId="author-save-loader"
                                />
                                <button id="author-cancel-btn" class="text-[10px] font-bold text-uu-main/40 uppercase tracking-[0.2em] hover:text-uu-main transition-all py-2">取消更變</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- CONTENT: SYSTEM -->
                <section id="tab-system" class="tab-content hidden w-full flex-1 flex flex-col p-10">
                    <div class="flex items-center justify-between mb-8 pb-6 border-b border-uu-sub/20">
                        <div class="flex items-center gap-3.5">
                            <div class="w-10 h-10 rounded-full bg-uu-sub/10 flex items-center justify-center text-uu-main">
                                <span class="material-symbols-outlined">payments</span>
                            </div>
                            <h3 class="font-bold text-xl text-uu-dark">全站設定</h3>
                        </div>
                        <div class="flex items-center gap-4 bg-uu-base/20 px-5 py-2.5 rounded-2xl border border-uu-sub/10">
                            <span class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest">贊助模組狀態</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="sys-donate-enabled" class="sr-only peer" checked />
                                <div class="w-11 h-6 bg-uu-sub/20 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-uu-sub/30 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-uu-main"></div>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-10">
                        <!-- Donation Config Section -->
                        <div class="bg-white border border-uu-sub/20 rounded-2xl p-8 space-y-8 shadow-sm">
                            <div class="flex items-center gap-3 mb-2 pb-4 border-b border-uu-sub/10">
                                <div class="w-8 h-8 rounded-lg bg-uu-main/5 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-uu-main text-sm">settings_heart</span>
                                </div>
                                <h4 class="text-xs font-black text-uu-dark uppercase tracking-widest">贊助詳情設定 (Donation Settings)</h4>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-3">
                                    <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest block">Platform Title (平台名稱)</label>
                                    <input
                                        type="text"
                                        id="sys-donate-name"
                                        class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-5 py-4 text-sm focus:outline-none focus:border-uu-main focus:bg-white transition-all shadow-inner"
                                        placeholder="例如：Buy Me a Coffee"
                                    />
                                </div>
                                <div class="space-y-3">
                                    <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest block">Donation Link (贊助連結)</label>
                                    <input
                                        type="text"
                                        id="sys-donate-url"
                                        class="w-full bg-uu-base/20 border border-uu-sub/20 rounded-xl px-5 py-4 text-sm focus:outline-none focus:border-uu-main focus:bg-white transition-all shadow-inner"
                                        placeholder="https://..."
                                    />
                                </div>
                            </div>

                            <div class="space-y-3">
                                <label class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest block">Display Message (顯示內容)</label>
                                <textarea
                                    id="sys-donate-msg"
                                    class="w-full bg-uu-base/10 border border-uu-sub/10 rounded-2xl p-8 text-sm leading-relaxed focus:outline-none focus:bg-white transition-all min-h-[160px] shadow-inner"
                                    placeholder="輸入您想對贊助者說的話..."></textarea>
                            </div>
                        </div>

                        <div class="pt-4 mt-4">
                            <PrimaryButton
                                id="save-sys-btn"
                                text="SAVE CONFIGURATION"
                                textId="save-btn-text"
                                showLoader={true}
                                loaderId="save-btn-loader"
                            />
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <Footer />
</Layout>

<script>
    import { auth, db } from "../../lib/firebase";
    import { onAuthStateChanged } from "firebase/auth";
    import {
        doc,
        getDoc,
        setDoc,
        collection,
        query,
        orderBy,
        onSnapshot,
        updateDoc,
        deleteDoc,
        addDoc,
        serverTimestamp,
    } from "firebase/firestore";

    const GAS_URL =
        "https://script.google.com/macros/s/AKfycbzIF6fuTnS-CPWBMe3UiVd3EtSKtj5CSde6BlPHGPVY6msOGJQupcY4L5QbmPHtKmdeGA/exec";

    const loading = document.getElementById("auth-loading");
    const dashboard = document.getElementById("admin-dashboard");
    const emailSpan = document.getElementById("admin-email");

    // --- Tab Logic ---
    const tabBtns = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");

    tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            const tabId = btn.getAttribute("data-tab");

            // Switch Buttons
            tabBtns.forEach((b) => {
                b.classList.remove(
                    "active",
                    "bg-uu-main",
                    "text-white",
                    "shadow-sm"
                );
                b.classList.add(
                    "text-uu-main/60",
                    "hover:bg-uu-sub/10",
                    "hover:text-uu-main"
                );
            });
            btn.classList.add(
                "active",
                "bg-uu-main",
                "text-white",
                "shadow-sm"
            );
            btn.classList.remove(
                "text-uu-main/60",
                "hover:bg-uu-sub/10",
                "hover:text-uu-main"
            );

            // Switch Content
            tabContents.forEach((c) => c.classList.add("hidden"));
            document.getElementById(`tab-${tabId}`)?.classList.remove("hidden");
        });
    });

    // --- Auth Check ---
    onAuthStateChanged(auth, async (user) => {
        if (user && user.email === "jing180804@gmail.com") {
            if (emailSpan) emailSpan.textContent = user.email;

            // Fetch Data
            fetchSystemConfig();
            fetchAuthorConfig();
            initCommentsModule();

            loading?.classList.add("opacity-0");
            setTimeout(() => {
                loading?.classList.add("hidden");
                dashboard?.classList.remove("hidden");
                dashboard?.classList.add("opacity-100");
            }, 300);
        } else {
            // Un-authorized
            window.location.href = "/user";
        }
    });

    // --- Logout ---
    document.getElementById("logout-btn")?.addEventListener("click", () => {
        auth.signOut();
    });

    // --- System Settings Firestore Logic ---
    const sysDonateName = document.getElementById(
        "sys-donate-name"
    ) as HTMLInputElement;
    const sysDonateUrl = document.getElementById(
        "sys-donate-url"
    ) as HTMLInputElement;
    const sysDonateMsg = document.getElementById(
        "sys-donate-msg"
    ) as HTMLTextAreaElement;
    const sysDonateEnabled = document.getElementById(
        "sys-donate-enabled"
    ) as HTMLInputElement;
    const saveSysBtn = document.getElementById("save-sys-btn");
    const saveBtnText = document.getElementById("save-btn-text");
    const saveBtnLoader = document.getElementById("save-btn-loader");

    async function fetchSystemConfig() {
        try {
            const docRef = doc(db, "site_config", "donation_settings");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (sysDonateName)
                    sysDonateName.value = data.platform_name || "";
                if (sysDonateUrl) sysDonateUrl.value = data.link_url || "";
                if (sysDonateMsg) sysDonateMsg.value = data.message || "";
                if (sysDonateEnabled)
                    sysDonateEnabled.checked = data.enabled ?? true;
            }
        } catch (err) {
            console.error("Error fetching config:", err);
        }
    }

    saveSysBtn?.addEventListener("click", async () => {
        if (!saveBtnText || !saveBtnLoader) return;

        saveBtnText.textContent = "SAVING...";
        saveBtnLoader.classList.remove("hidden");
        saveSysBtn.setAttribute("disabled", "true");

        try {
            await setDoc(doc(db, "site_config", "donation_settings"), {
                platform_name: sysDonateName.value,
                link_url: sysDonateUrl.value,
                message: sysDonateMsg.value,
                enabled: sysDonateEnabled.checked,
            });

            saveBtnText.textContent = "SAVED SUCCESS!";
            setTimeout(() => {
                saveBtnText.textContent = "SAVE CONFIGURATION";
            }, 2000);
        } catch (err) {
            alert("Save failed: " + err);
            saveBtnText.textContent = "ERROR";
        } finally {
            saveBtnLoader.classList.add("hidden");
            saveSysBtn.removeAttribute("disabled");
        }
    });

    // --- Author Settings Logic ---
    const authorPreview = document.getElementById("author-preview");
    const authorEditor = document.getElementById("author-editor");
    const authorEditToggle = document.getElementById("author-edit-toggle");
    const authorCancelBtn = document.getElementById("author-cancel-btn");
    const authorSaveBtn = document.getElementById("author-save-btn");
    const authorMdEditor = document.getElementById("author-md-editor") as HTMLTextAreaElement;
    const authorDisplayContent = document.getElementById("author-display-content");
    const authorSaveLoader = document.getElementById("author-save-loader");

    async function fetchAuthorConfig() {
        try {
            const docRef = doc(db, "site_config", "about_me");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (authorMdEditor) authorMdEditor.value = data.content || "";
                if (authorDisplayContent) {
                    authorDisplayContent.innerHTML = data.content ? 
                        data.content.split('\n').map(line => `<p>${line}</p>`).join('') : 
                        '<p class="text-uu-main/30 italic">尚無內容，請點擊編輯...</p>';
                }
            }
        } catch (err) {
            console.error("Error fetching author config:", err);
        }
    }

    authorEditToggle?.addEventListener("click", () => {
        authorPreview?.classList.add("hidden");
        authorEditor?.classList.remove("hidden");
    });

    authorCancelBtn?.addEventListener("click", () => {
        authorEditor?.classList.add("hidden");
        authorPreview?.classList.remove("hidden");
    });

    authorSaveBtn?.addEventListener("click", async () => {
        if (!authorMdEditor || !authorSaveLoader) return;
        
        authorSaveLoader.classList.remove("hidden");
        authorSaveBtn.setAttribute("disabled", "true");

        try {
            await setDoc(doc(db, "site_config", "about_me"), {
                content: authorMdEditor.value,
                updated_at: serverTimestamp()
            });
            
            await fetchAuthorConfig();
            authorEditor?.classList.add("hidden");
            authorPreview?.classList.remove("hidden");
        } catch (err) {
            alert("儲存失敗: " + err);
        } finally {
            authorSaveLoader.classList.add("hidden");
            authorSaveBtn.removeAttribute("disabled");
        }
    });

    // --- MD Upload & Drag/Drop ---
    const dropzone = document.getElementById("md-dropzone");
    const mdInput = document.getElementById(
        "md-file-input"
    ) as HTMLInputElement;
    const mdEditor = document.getElementById(
        "md-content"
    ) as HTMLTextAreaElement;
    const slugInput = document.getElementById("post-slug") as HTMLInputElement;

    dropzone?.addEventListener("click", () => mdInput.click());
    dropzone?.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("border-uu-main", "bg-uu-main/5");
    });
    dropzone?.addEventListener("dragleave", () => {
        dropzone.classList.remove("border-uu-main", "bg-uu-main/5");
    });
    dropzone?.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("border-uu-main", "bg-uu-main/5");
        const file = e.dataTransfer?.files[0];
        if (file && file.name.endsWith(".md")) handleMd(file);
    });
    mdInput?.addEventListener("change", () => {
        if (mdInput.files?.[0]) handleMd(mdInput.files[0]);
    });

    function handleMd(file: File) {
        const reader = new FileReader();
        reader.onload = (e) => {
            mdEditor.value = e.target?.result as string;
            // Suggest slug
            const base = file.name.replace(".md", "");
            slugInput.value = base.toLowerCase().replace(/\s+/g, "-");
        };
        reader.readAsText(file);
    }

    // --- Image Processing ---
    const imageInput = document.getElementById(
        "image-input"
    ) as HTMLInputElement;
    const imageQueue = document.getElementById("image-queue");

    imageInput?.addEventListener("change", async () => {
        const files = imageInput.files;
        if (!files) return;
        for (const file of Array.from(files)) {
            const processed = await processImage(file);
            renderImagePreview(processed, file.name);
        }
    });

    async function processImage(
        file: File
    ): Promise<{ url: string; type: string; w: number; h: number }> {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d")!;
                    let tw, th, itype;

                    if (img.width > img.height) {
                        // Landscape -> Crop to 1200x630
                        itype = "Landscape";
                        tw = 1200;
                        th = 630;
                        const ratio = 1200 / 630;
                        let sw, sh, sx, sy;
                        if (img.width / img.height > ratio) {
                            sh = img.height;
                            sw = img.height * ratio;
                            sx = (img.width - sw) / 2;
                            sy = 0;
                        } else {
                            sw = img.width;
                            sh = img.width / ratio;
                            sx = 0;
                            sy = (img.height - sh) / 2;
                        }
                        canvas.width = tw;
                        canvas.height = th;
                        ctx.drawImage(img, sx, sy, sw, sh, 0, 0, tw, th);
                    } else if (img.height > img.width) {
                        // Portrait -> Fixed H1200
                        itype = "Portrait";
                        th = 1200;
                        tw = (img.width * 1200) / img.height;
                        canvas.width = tw;
                        canvas.height = th;
                        ctx.drawImage(img, 0, 0, tw, th);
                    } else {
                        // Square -> 1200x1200
                        itype = "Square";
                        tw = 1200;
                        th = 1200;
                        canvas.width = tw;
                        canvas.height = th;
                        ctx.drawImage(img, 0, 0, tw, th);
                    }
                    resolve({
                        url: canvas.toDataURL("image/jpeg", 0.9),
                        type: itype,
                        w: Math.round(tw),
                        h: Math.round(th),
                    });
                };
                img.src = e.target?.result as string;
            };
            reader.readAsDataURL(file);
        });
    }

    // --- Comments Management Module ---
    const commentsList = document.getElementById("comments-list");
    const commentStats = document.getElementById("comment-stats");
    const filterBtns = document.querySelectorAll(".comment-filter");
    let activeFilter = "latest";
    let allComments: any[] = [];

    function initCommentsModule() {
        const q = query(
            collection(db, "comments"),
            orderBy("created_at", "asc") // Sort by asc so replies appear in order after grouping
        );
 
        onSnapshot(q, (snapshot) => {
            allComments = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
            }));
            // Sort local array descending for top-level display, but keep original for nested lookups
            const sortedComments = [...allComments].sort((a,b) => (b.created_at?.seconds || 0) - (a.created_at?.seconds || 0));
            renderComments(sortedComments);
            if (commentStats)
                commentStats.textContent = `${allComments.filter(c => !c.parent_id).length} 原生留言`;
        });

 
        filterBtns.forEach((btn) => {
            btn.addEventListener("click", () => {
                filterBtns.forEach((b) => {
                    b.classList.remove("active", "bg-white", "text-uu-dark");
                    b.classList.add("text-uu-main/40");
                });
                btn.classList.add("active", "bg-white", "text-uu-dark");
                btn.classList.remove("text-uu-main/40");
                activeFilter = btn.getAttribute("data-filter") || "latest";
                renderComments(allComments);
            });
        });
    }


    function renderComments(comments: any[]) {
        if (!commentsList) return;

        // Separate top-level comments and replies
        const topLevel = comments.filter(c => !c.parent_id);
        const replies = comments.filter(c => c.parent_id);

        const filtered = topLevel.filter((c) => {
            if (activeFilter === "latest") return !c.is_read && !c.is_hidden && !c.is_deleted;
            if (activeFilter === "hidden") return c.is_hidden && !c.is_deleted;
            if (activeFilter === "deleted") return c.is_deleted;
            return !c.is_hidden && !c.is_deleted; // Default view is ALL (includes read/unread, but not hidden/deleted)
        });

        if (filtered.length === 0) {
            commentsList.innerHTML = `<div class="py-20 text-center opacity-30 text-xs font-bold tracking-widest uppercase">目前沒有符合條件的留言</div>`;
            return;
        }

        commentsList.innerHTML = filtered
            .map((c) => {
                const date = c.created_at?.toDate ? c.created_at.toDate().toLocaleString() : "剛剛";
                const belongsTo = c.post_slug || "全站";
                
                // Find replies to this comment
                const myReplies = replies.filter(r => r.parent_id === c.id);

                return `
                <div class="bg-white border border-uu-sub/20 rounded-2xl p-6 transition-all hover:border-uu-main/30 group ${c.is_hidden ? "opacity-60 grayscale" : ""}">
                    <!-- Main Comment Info -->
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-uu-sub/10 flex items-center justify-center overflow-hidden border border-uu-sub/20">
                                ${c.author_avatar ? `<img src="${c.author_avatar}" class="w-full h-full object-cover">` : `<span class="material-symbols-outlined text-uu-main/40">person</span>`}
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-uu-dark flex items-center gap-2">
                                    ${c.author_name || "訪客"}
                                </h4>
                                <p class="text-[10px] text-uu-main/40 font-mono italic">${c.author_email || "未提供信箱"}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black text-uu-main/30 mb-1 uppercase tracking-tighter">
                                來自：<a href="/posts/${c.post_slug}" target="_blank" class="text-uu-main/60 hover:text-uu-main hover:underline decoration-uu-sub/50 underline-offset-2">${belongsTo}</a>
                            </p>
                            <p class="text-[9px] text-uu-main/30">${date}</p>
                        </div>
                    </div>
                    
                    <div class="bg-uu-base/10 rounded-xl p-4 mb-4 text-sm text-uu-main/80 leading-relaxed">
                        ${c.content}
                    </div>

                    <!-- My Replies Section -->
                    ${myReplies.length > 0 ? `
                        <div class="space-y-3 mb-4 mt-2 pl-6 border-l-2 border-uu-sub/20">
                            ${myReplies.map(r => `
                                <div class="bg-uu-main/5 rounded-xl p-4 border border-uu-main/10 relative">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-6 h-6 rounded-full overflow-hidden border border-uu-main/20">
                                            <img src="/uu-memo.png" class="w-full h-full object-cover">
                                        </div>
                                        <div class="flex-1 flex justify-between items-center">
                                            <span class="text-[10px] font-black text-uu-main tracking-wider">UU (站長)</span>
                                            <div class="flex items-center gap-4">
                                                <span class="text-[8px] text-uu-main/40 font-mono">${r.created_at?.toDate ? r.created_at.toDate().toLocaleString() : '剛剛'}</span>
                                                <button class="action-perm-delete opacity-40 hover:opacity-100 text-uu-main transition-opacity" data-id="${r.id}">
                                                    <span class="material-symbols-outlined text-sm">delete</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-[11px] text-uu-main/80 leading-relaxed">${r.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- Action Bar -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            ${!c.is_read && !c.is_deleted ? `<button class="action-read text-[10px] font-black text-uu-main hover:underline" data-id="${c.id}">標記已讀</button>` : ""}
                            <button class="action-hide text-[10px] font-black text-uu-main/40 hover:text-uu-main" data-id="${c.id}">${c.is_hidden ? "取消隱藏" : "隱藏留言"}</button>
                            <button class="action-delete text-[10px] font-black text-uu-main/40 hover:text-uu-main" data-id="${c.id}">${c.is_deleted ? '永久刪除' : '移至回收桶'}</button>
                        </div>
                        <button class="action-reply-toggle flex items-center gap-1.5 px-4 py-1.5 bg-uu-dark text-white rounded-lg text-[10px] font-bold hover:bg-uu-main transition-all" data-id="${c.id}">
                            <span class="material-symbols-outlined text-xs">reply</span>
                            回覆內容
                        </button>
                    </div>

                    <!-- Hidden Reply Form -->
                    <div id="reply-form-${c.id}" class="hidden mt-6 pt-6 border-t border-uu-sub/10">
                        <div class="space-y-3">
                            <label class="text-[9px] font-bold text-uu-main/40 uppercase tracking-widest">管理員回覆</label>
                            <textarea class="reply-textarea w-full bg-white border border-uu-sub/30 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-uu-main transition-all h-24 shadow-inner" placeholder="輸入回覆內容..."></textarea>
                            <div class="flex justify-end gap-2">
                                <button class="cancel-reply text-[10px] font-bold text-uu-main/40 hover:text-uu-dark" data-id="${c.id}">取消</button>
                                <button class="send-reply bg-uu-main text-white px-5 py-2 rounded-lg text-[10px] font-black tracking-widest uppercase hover:bg-uu-dark transition-all" data-id="${c.id}" data-slug="${c.post_slug}">發送回覆</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join("");



        // Attach Event Listeners
        commentsList.querySelectorAll(".action-read").forEach((btn) => {
            btn.addEventListener("click", () => markAsRead(btn.getAttribute("data-id")!));
        });
        commentsList.querySelectorAll(".action-hide").forEach((btn) => {
            btn.addEventListener("click", () =>
                toggleCommentVisibility(btn.getAttribute("data-id")!, true)
            );
        });
        commentsList.querySelectorAll(".action-unhide").forEach((btn) => {
            btn.addEventListener("click", () =>
                toggleCommentVisibility(btn.getAttribute("data-id")!, false)
            );
        });
        commentsList.querySelectorAll(".action-delete").forEach((btn) => {
            btn.addEventListener("click", () =>
                destructiveAction(btn.getAttribute("data-id")!)
            );
        });

        // Specific Permanent Delete for nested replies
        commentsList.querySelectorAll(".action-perm-delete").forEach((btn) => {
            btn.addEventListener("click", () => {
                if(confirm("確定要永久刪除此條回覆？")) {
                    deleteDoc(doc(db, "comments", btn.getAttribute("data-id")!));
                }
            });
        });

        // Reply UI Toggle
        commentsList.querySelectorAll(".action-reply-toggle").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.getAttribute("data-id");
                const form = document.getElementById(`reply-form-${id}`);
                form?.classList.toggle("hidden");
            });
        });

        commentsList.querySelectorAll(".cancel-reply").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.getAttribute("data-id");
                const form = document.getElementById(`reply-form-${id}`);
                form?.classList.add("hidden");
            });
        });

        commentsList.querySelectorAll(".send-reply").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.getAttribute("data-id");
                const slug = btn.getAttribute("data-slug");
                const textarea = document.querySelector(`#reply-form-${id} textarea`) as HTMLTextAreaElement;
                if (textarea.value.trim()) {
                    submitReply(id!, slug!, textarea.value);
                }
            });
        });
    }

    async function markAsRead(id: string) {
        try {
            await updateDoc(doc(db, "comments", id), { is_read: true });
        } catch (e) { console.error(e); }
    }

    async function toggleCommentVisibility(id: string, hide: boolean) {
        try {
            await updateDoc(doc(db, "comments", id), { is_hidden: hide });
        } catch (e) {
            alert("操作失敗: " + e);
        }
    }

    async function destructiveAction(id: string) {
        const comment = allComments.find(c => c.id === id);
        if (!comment) return;

        if (comment.is_deleted) {
            // Permanent Delete
            if (!confirm("確定要將這條留言從資料庫徹底移除嗎？此操作不可恢復。")) return;
            try {
                await deleteDoc(doc(db, "comments", id));
            } catch (e) { alert("刪除失敗: " + e); }
        } else {
            // Move to Trash
            if (!confirm("將此留言移至回收桶？")) return;
            try {
                await updateDoc(doc(db, "comments", id), { is_deleted: true });
            } catch (e) { alert("移動失敗: " + e); }
        }
    }

    async function submitReply(parentId: string, postSlug: string, content: string) {
        try {
            await addDoc(collection(db, "comments"), {
                author_name: "UU (站長)",
                author_email: "jing180804@gmail.com",
                author_avatar: "/uu-memo.png",
                content: content,
                post_slug: postSlug,
                parent_id: parentId, // Links to original comment
                is_hidden: false,
                is_deleted: false,
                is_read: true,
                created_at: serverTimestamp()
            });
            // Mark original as read
            await markAsRead(parentId);
            alert("回覆已發送");
            const form = document.getElementById(`reply-form-${parentId}`);
            form?.classList.add("hidden");
        } catch (e) {
            alert("發送失敗: " + e);
        }
    }


    function renderImagePreview(
        data: { url: string; type: string; w: number; h: number },
        name: string
    ) {
        if (!imageQueue) return;
        const card = document.createElement("div");
        card.className =
            "bg-white border border-uu-sub/20 rounded-2xl p-4 flex gap-4 items-start group relative";

        // Use aspect ratio based on type
        let aspect = "aspect-video"; // 1200x630
        if (data.type === "Portrait") aspect = "aspect-[3/4]";
        if (data.type === "Square") aspect = "aspect-square";

        card.innerHTML = `
            <div class="w-16 ${aspect} rounded-lg overflow-hidden bg-uu-sub/10 flex-shrink-0 border border-uu-sub/10">
                <img src="${data.url}" class="w-full h-full object-cover" />
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-[9px] font-black bg-uu-main/10 text-uu-main px-1.5 py-0.5 rounded">${data.type}</span>
                    <span class="text-[9px] text-uu-main/40 uppercase font-mono">${data.w} × ${data.h}</span>
                </div>
                <p class="text-[10px] font-bold text-uu-dark truncate mb-2">${name}</p>
                <input type="text" placeholder="YYMMDD-slug-01" class="w-full bg-uu-base/10 border-none rounded-lg px-2 py-1.5 text-[10px] italic focus:ring-1 focus:ring-uu-main/30" />
            </div>
            <button class="absolute top-2 right-2 text-uu-main/20 hover:text-uu-dark opacity-0 group-hover:opacity-100 transition-opacity" onclick="this.parentElement.remove()">
                <span class="material-symbols-outlined text-sm">close</span>
            </button>
        `;
        imageQueue.appendChild(card);
    }

    // --- Seeding Logic ---
    const seedBtn = document.getElementById("seed-comments-btn");
    seedBtn?.addEventListener("click", async () => {
        if (!confirm("Add 3 test comments to Firestore?")) return;

        const testData = [
            {
                author_name: "小林",
                author_email: "lin@example.com",
                content:
                    "這篇文章寫得很有溫度，圖片的色調也配得很安靜。期待更多的分享！",
                post_slug: "2024-spring-trip",
                is_hidden: false,
                is_deleted: false,
                is_read: false,
                created_at: serverTimestamp(),
            },
            {
                author_name: "Art Explorer",
                author_email: "art@travel.io",
                content:
                    "關於膠卷攝影的那一段很有同感，那種等待沖洗的不確定感才是最迷人的地方。",
                post_slug: "film-photography-essence",
                is_hidden: true,
                is_deleted: false,
                is_read: false,
                created_at: serverTimestamp(),
            },
            {
                author_name: "匿名訪客",
                author_email: "",
                content: "請問這張照片是在哪裡拍的？構圖好美！",
                post_slug: "kyoto-morning-walk",
                is_hidden: false,
                is_deleted: false,
                is_read: true,
                created_at: serverTimestamp(),
            },
        ];

        try {
            for (const item of testData) {
                await addDoc(collection(db, "comments"), item);
            }
            alert("Test data seeded successfully!");
        } catch (e) {
            alert("Seeding failed: " + e);
        }
    });
</script>

<style>
    /* Reuse User Dashboard Styles */
    .dashboard-layout {
        display: grid;
        grid-template-columns: 288px minmax(0, 1fr);
        gap: 2.5rem;
        align-items: start;
        width: 100%;
    }
    .dashboard-sidebar {
        width: 288px;
        position: sticky;
        top: 6rem;
    }
    .dashboard-content {
        min-width: 0;
        width: 100%;
        overflow: hidden;
    }

    /* Mobile Responsive */
    @media (max-width: 767px) {
        .dashboard-layout {
            display: flex;
            flex-direction: column;
        }
        .dashboard-sidebar {
            width: 100%;
            position: static;
        }
    }

    /* Scrollbar for editor */
    #md-content::-webkit-scrollbar {
        width: 6px;
    }
    #md-content::-webkit-scrollbar-thumb {
        background: rgba(26, 26, 26, 0.1);
        border-radius: 10px;
    }
</style>
