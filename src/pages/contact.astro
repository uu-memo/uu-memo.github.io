---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import PrimaryButton from "../components/PrimaryButton.astro";
---

<Layout title="合作聯繫 | UU MEMO">
    <Header />
    <main
        class="max-w-4xl mx-auto px-6 py-12 md:py-20 min-h-[70vh] w-full self-stretch"
    >
        <article
            class="bg-uu-light rounded-2xl p-8 md:p-12 shadow-sm border border-uu-sub"
        >
            <header class="mb-12 text-center">
                <h1 class="text-3xl font-bold text-uu-main mb-4 tracking-tight">
                    合作聯繫
                </h1>
                <p class="text-uu-main/60 text-sm">
                    如果您有任何合作提案或建議，歡迎填寫下表與我聯繫。
                </p>
            </header>

            <form id="contact-form" class="space-y-6 max-w-2xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label
                            for="name"
                            class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest pl-1"
                            >Your Name</label
                        >
                        <input
                            type="text"
                            id="name"
                            name="name"
                            required
                            class="w-full bg-uu-base/20 border border-uu-sub/30 rounded-xl px-4 py-3.5 text-sm focus:outline-none focus:border-uu-main transition-all placeholder:text-uu-main/20"
                            placeholder="您的姓名"
                        />
                    </div>
                    <div class="space-y-2">
                        <label
                            for="email"
                            class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest pl-1"
                            >Email Address</label
                        >
                        <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            class="w-full bg-uu-base/20 border border-uu-sub/30 rounded-xl px-4 py-3.5 text-sm focus:outline-none focus:border-uu-main transition-all placeholder:text-uu-main/20"
                            placeholder="your@email.com"
                        />
                    </div>
                </div>

                <div class="space-y-2">
                    <label
                        for="subject"
                        class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest pl-1"
                        >Subject</label
                    >
                    <input
                        type="text"
                        id="subject"
                        name="subject"
                        required
                        class="w-full bg-uu-base/20 border border-uu-sub/30 rounded-xl px-4 py-3.5 text-sm focus:outline-none focus:border-uu-main transition-all placeholder:text-uu-main/20"
                        placeholder="主旨"
                    />
                </div>

                <div class="space-y-2">
                    <label
                        for="message"
                        class="text-[10px] font-black text-uu-main/40 uppercase tracking-widest pl-1"
                        >Message</label
                    >
                    <textarea
                        id="message"
                        name="message"
                        rows="6"
                        required
                        class="w-full bg-uu-base/20 border border-uu-sub/30 rounded-xl px-4 py-3.5 text-sm focus:outline-none focus:border-uu-main transition-all placeholder:text-uu-main/20 resize-none"
                        placeholder="請輸入您的訊息內容..."></textarea>
                </div>

                <div class="pt-4">
                    <PrimaryButton
                        id="submit-btn"
                        text="SEND MESSAGE"
                        icon="send"
                        showLoader={true}
                        loaderId="submit-loader"
                    />
                </div>

                <div id="form-status" class="hidden animate-fade-in">
                    <p
                        class="text-center text-sm font-bold text-uu-main bg-uu-sub/20 py-4 rounded-xl"
                    >
                    </p>
                </div>
            </form>
        </article>
    </main>
    <Footer />
</Layout>

<script>
    import { db } from "../lib/firebase";
    import { collection, addDoc, serverTimestamp } from "firebase/firestore";

    const GAS_URL = import.meta.env.PUBLIC_GAS_URL;
    const GAS_SECRET = import.meta.env.PUBLIC_GAS_SECRET;

    function initContactForm() {
        const form = document.getElementById("contact-form") as HTMLFormElement;
        const submitBtn = document.getElementById("submit-btn");
        const loader = document.getElementById("submit-loader");
        const statusDiv = document.getElementById("form-status");
        const statusText = statusDiv?.querySelector("p");

        if (!form || !submitBtn) return;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!GAS_URL) {
                console.error("Missing GAS_URL configuration.");
                if (statusText)
                    statusText.textContent = "系統設定錯誤，請聯繫管理員。";
                statusDiv?.classList.remove("hidden");
                return;
            }

            submitBtn.setAttribute("disabled", "true");
            loader?.classList.remove("hidden");
            if (statusDiv) statusDiv.classList.add("hidden");

            const formData = new FormData(form);
            const data = {
                name: formData.get("name"),
                email: formData.get("email"),
                subject: formData.get("subject"),
                message: formData.get("message"),
                token: GAS_SECRET, // Add secret token to payload
                timestamp: serverTimestamp(),
            };

            try {
                console.log("[Contact] Submitting to Firestore...");
                // 1. Save to Firestore
                await addDoc(collection(db, "messages"), data);
                console.log("[Contact] Firestore save successful.");

                // 2. Send to GAS (Email forward)
                if (GAS_URL) {
                    console.log("[Contact] Sending to GAS: " + GAS_URL);
                    try {
                        // We use no-cors because GAS doesn't handle CORS preflight easily.
                        // This means we can't read the response, but the request will go through.
                        await fetch(GAS_URL, {
                            method: "POST",
                            mode: "no-cors",
                            cache: "no-cache",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(data),
                        });
                        console.log(
                            "[Contact] GAS request sent (Opaque response)."
                        );
                    } catch (gasError) {
                        console.error("[Contact] GAS fetch failed:", gasError);
                    }
                } else {
                    console.warn(
                        "[Contact] GAS_URL is missing, skipping email notification."
                    );
                }

                form.reset();
                if (statusText)
                    statusText.textContent = "訊息已成功送出，我會盡快回覆您！";
                statusDiv?.classList.remove("hidden");
            } catch (error) {
                console.error("[Contact] Submission error:", error);
                if (statusText)
                    statusText.textContent =
                        "送出失敗，請檢查網路連線或稍後再試。";
                statusDiv?.classList.remove("hidden");
            } finally {
                submitBtn.removeAttribute("disabled");
                loader?.classList.add("hidden");
            }
        });
    }

    document.addEventListener("astro:page-load", initContactForm);
</script>
