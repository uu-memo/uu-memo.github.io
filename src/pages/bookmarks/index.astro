---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

// Fetch all posts to have their metadata available
const allPosts = await getCollection("posts");
const postsJson = allPosts.map((post) => ({
    id: post.id,
    title: post.data.title,
    description: post.data.description,
    pubDate: post.data.pubDate,
    heroImage: post.data.heroImage,
    category: post.data.category,
    tags: post.data.tags,
}));
---

<Layout title="我的書籤 - UU MEMO">
    <Header />
    <main class="max-w-6xl mx-auto px-6 py-12 md:py-20 min-h-[70vh]">
        <div class="flex items-center gap-4 mb-12 border-b border-uu-sub pb-6">
            <span class="material-symbols-outlined text-3xl text-uu-main"
                >bookmarks</span
            >
            <h1 class="text-3xl font-bold text-uu-main">我的書籤</h1>
        </div>

        <!-- Auth State Message (Internal Login) -->
        <div id="auth-check" class="hidden py-8 text-center">
            <div
                id="login-section"
                class="opacity-0 translate-y-4 transition-all duration-500 max-w-md mx-auto w-full bg-uu-light p-10 rounded-2xl shadow-sm border border-uu-sub text-center"
            >
                <h2 class="text-2xl font-bold mb-4 font-logo text-uu-dark">
                    開啟你在 UU MEMO 的收藏夾
                </h2>
                <p class="text-uu-main/60 mb-8 text-sm leading-relaxed">
                    登入後即可同步您的書籤，找回觸動心靈的瞬間。
                </p>

                <button
                    id="google-login-btn"
                    class="w-full bg-white border border-uu-sub hover:border-uu-main hover:bg-uu-base/30 text-uu-dark font-medium py-3.5 px-4 rounded-xl transition-all duration-300 flex items-center justify-center gap-3 group mb-6 active:scale-[0.98]"
                >
                    <svg
                        class="w-5 h-5 group-hover:scale-110 transition-transform"
                        viewBox="0 0 24 24"
                    >
                        <path
                            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                            fill="#4285F4"></path>
                        <path
                            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                            fill="#34A853"></path>
                        <path
                            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                            fill="#FBBC05"></path>
                        <path
                            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                            fill="#EA4335"></path>
                    </svg>
                    <span>使用 Google 帳戶繼續</span>
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="bookmarks-loading" class="hidden py-20 text-center">
            <div
                class="w-10 h-10 border-4 border-uu-sub border-t-uu-main rounded-full animate-spin mx-auto mb-4"
            >
            </div>
            <p class="text-uu-main/60 text-sm tracking-widest">
                LOADING BOOKMARKS...
            </p>
        </div>

        <!-- Empty State -->
        <div
            id="bookmarks-empty"
            class="hidden py-20 text-center bg-uu-light rounded-2xl border border-uu-sub shadow-sm"
        >
            <span class="material-symbols-outlined text-5xl mb-4 text-uu-sub"
                >bookmark_border</span
            >
            <p class="text-uu-main/60">目前還沒有收藏的文章。</p>
            <a
                href="/posts"
                class="inline-block mt-6 text-uu-main underline text-sm hover:text-uu-dark"
                >去看看文章</a
            >
        </div>

        <!-- Bookmarks Grid -->
        <div
            id="bookmarks-grid"
            class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
            data-posts={JSON.stringify(postsJson)}
        >
            <!-- Dynamic Content -->
        </div>
    </main>
    <Footer />
</Layout>

<script>
    import { auth, db, googleProvider } from "../../lib/firebase";
    import { onAuthStateChanged, signInWithPopup } from "firebase/auth";
    import { collection, getDocs, query, orderBy } from "firebase/firestore";

    function initBookmarks() {
        const authCheck = document.getElementById("auth-check");
        const loginSection = document.getElementById("login-section");
        const loginBtn = document.getElementById("google-login-btn");
        const loadingState = document.getElementById("bookmarks-loading");
        const emptyState = document.getElementById("bookmarks-empty");
        const gridState = document.getElementById("bookmarks-grid");
        const postsJson = JSON.parse(
            gridState?.getAttribute("data-posts") || "[]"
        );

        if (!gridState) return;

        loginBtn?.addEventListener("click", async () => {
            try {
                await signInWithPopup(auth, googleProvider);
            } catch (e) {
                console.error("Login failed:", e);
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authCheck?.classList.add("hidden");
                loginSection?.classList.add("hidden");
                loadingState?.classList.remove("hidden");
                emptyState?.classList.add("hidden");
                gridState?.classList.add("hidden");

                try {
                    // Fetch saved bookmark IDs from Firestore
                    const q = query(
                        collection(db, "users", user.uid, "bookmarks"),
                        orderBy("timestamp", "desc")
                    );
                    const querySnapshot = await getDocs(q);
                    const bookmarkedIds = querySnapshot.docs.map(
                        (doc) => doc.id
                    );

                    if (bookmarkedIds.length === 0) {
                        loadingState?.classList.add("hidden");
                        emptyState?.classList.remove("hidden");
                    } else {
                        renderBookmarks(
                            bookmarkedIds,
                            postsJson,
                            gridState,
                            loadingState
                        );
                    }
                } catch (e) {
                    console.error("Error fetching bookmarks:", e);
                    loadingState?.classList.add("hidden");
                    emptyState?.classList.remove("hidden");
                }
            } else {
                authCheck?.classList.remove("hidden");
                if (loginSection) {
                    loginSection.classList.remove("hidden");
                    setTimeout(() => {
                        loginSection.classList.add("opacity-100");
                        loginSection.classList.remove("translate-y-4");
                    }, 50);
                }
                loadingState?.classList.add("hidden");
                emptyState?.classList.add("hidden");
                gridState?.classList.add("hidden");
            }
        });
    }

    function renderBookmarks(
        ids: string[],
        posts: any[],
        grid: HTMLElement,
        loading: HTMLElement | null
    ) {
        // Filter local posts by bookmarked IDs
        const bookmarkedPosts = posts.filter((post) => ids.includes(post.id));

        // Sort by the order in the IDs array (which is desc by timestamp)
        bookmarkedPosts.sort((a, b) => ids.indexOf(a.id) - ids.indexOf(b.id));

        grid.innerHTML = bookmarkedPosts
            .map(
                (post) => `
            <article class="bg-uu-light rounded-2xl overflow-hidden border border-uu-sub group shadow-sm hover:shadow-md transition-shadow flex flex-col h-full">
                ${
                    post.heroImage
                        ? `
                    <a href="/posts/${post.id}" class="aspect-[16/10] bg-uu-sub/20 relative overflow-hidden shrink-0 block">
                        <img src="${post.heroImage}" alt="" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
                    </a>
                `
                        : `
                    <a href="/posts/${post.id}" class="aspect-[16/10] bg-uu-sub/20 flex items-center justify-center text-uu-main/20 shrink-0 block">
                        <span class="material-symbols-outlined text-5xl">image</span>
                    </a>
                `
                }
                <div class="p-6 flex flex-col flex-1">
                    <div class="text-[10px] tracking-widest text-uu-main/60 mb-2 font-medium flex justify-between items-center">
                        <span>${new Date(post.pubDate).toLocaleDateString(
                            "zh-TW"
                        )}</span>
                        <span class="text-uu-main/80 uppercase">${
                            Array.isArray(post.category)
                                ? post.category[0]
                                : post.category || "LIFE"
                        }</span>
                    </div>
                    <h3 class="text-lg font-bold mb-3 group-hover:text-uu-dark transition-colors line-clamp-2">
                        <a href="/posts/${post.id}">${post.title}</a>
                    </h3>
                    <p class="text-sm opacity-70 line-clamp-2 mb-4 leading-relaxed flex-1">
                        ${post.description}
                    </p>
                    <a href="/posts/${
                        post.id
                    }" class="text-sm font-bold self-start mt-auto text-uu-main hover:text-uu-dark transition-colors flex items-center gap-1">
                        閱讀全文
                        <span class="material-symbols-outlined text-sm">arrow_forward</span>
                    </a>
                </div>
            </article>
        `
            )
            .join("");

        loading?.classList.add("hidden");
        grid.classList.remove("hidden");
        grid.classList.add("grid");
    }

    initBookmarks();
    document.addEventListener("astro:page-load", initBookmarks);
</script>
