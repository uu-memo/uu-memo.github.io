# 系統對接排查報告 (System Integration Audit Report)
**日期：2026-02-28**
**目標：審核使用者端 (User)、管理員端 (Admin) 與 Firebase 後端資料庫之對接現狀**

---

## ✅ 1. 已處理事項 (Resolved / Handled)

### A. 管理員身份定義對齊
*   **狀況**：已確認 `jing180804@gmail.com` 為唯一的管理員登入帳號（符合 `firestore.rules`）。
*   **調整**：已修正 `Comments.astro` 與 `admin/index.astro` 中的判斷邏輯，改為偵測 `jing180804@gmail.com` 作為管理員標記。
*   **聯絡資訊**：`uu-memo@outlook.com` 將僅保留作為留言時的「聯絡 Email」存入資料庫，不作為權限判斷依據。

### B. 會員中心「書籤」與「留言」的排序索引
*   **發現狀況**：使用者端的留言管理使用了 `getDocs` 並在客戶端排序，以避免複合索引 (Composite Index) 的需求。然而，若書籤 (Bookmarks) 數量增長，目前的 `orderBy("timestamp", "desc")` 可能會遇到同樣的報錯或效能瓶頸。
*   **處理建議**：建議在 Firebase Console 手動建立對應索引，或全面改為客戶端排序以維持開發彈性。

---

## ⚡ 2. 可優化事項 (Optimizable)

### A. 管理員 UID 硬編碼優化
*   **發現狀況**：目前為了安全與準確性，部分代碼中硬編碼了管理員的 UID (`P9G0w4qEa9gY6ZRY8K8oYVbS7zJ2`)。
*   **優化建議**：應將此類敏感 UID 抽離至 `.env` 環境變數中（若專案架構支援），或透過專屬的 `admin_vault` 文件在登入後動態獲取，減少代碼更改時的維護成本。

### B. 留言載入的快取機制
*   **發現狀況**：目前文章頁採用 `onSnapshot` 即時監聽。當留言數量極大時，頻繁的 UID 檔案查詢（`getDoc`）會造成不必要的 Firebase Read 消耗。
*   **優化建議**：可以建立一個簡單的客戶端快取 (`userCache`)，在單次頁面載入中，重複出現的 UID 僅抓取一次。

---

## ✅ 3. 無異狀事項 (Healthy / Normal)

### A. 留言 UID 非同步渲染
*   **狀態**：**運作良好**。已建立嚴格的 UID 優先機制，無論留言何時發佈，皆能正確對應當前最新的使用者頭像與暱稱。

### B. 管理後台「影像工坊」
*   **狀態**：**運作良好**。修復 `imageQueue` 引用錯誤後，圖片的前端處理、預覽與檔名生成邏輯皆正常且流暢。

### C. 訪客模式隔離
*   **狀態**：**運作良好**。訪客留言與會員留言在後端資料結構上已正確區分，安全性規則也成功限制了訪客對留言的修改權限。

---

## 📖 總結與建議路徑
目前的系統架構在「正確性」上已達標，尤其是解決了身份同步的棘手問題。下一步應優先處理 **Email 定義不一致** 的問題，確保管理權限在「安全性規則」層級也是穩固的。

---
**審核執行：Antigravity Engineering Agent**
**2026-02-28**
