rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 輔助函式：判斷是否為管理員
    function isAdmin() {
      return request.auth != null && request.auth.token.email == "jing180804@gmail.com";
    }

    // --- 管理員專區 (Admin Trap) ---
    // 只有真正的管理員可以讀寫此文件，前端以此作為「權限憑證」
    match /admin_vault/credentials {
      allow read, write: if isAdmin();
    }

    // --- 全域權限控制 ---
    match /{document=**} {
      // 只有管理員可以寫入任意內容，一般使用者由下方規則細分
      allow write: if isAdmin();
    }

    // 允許使用者讀寫自己的資料
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /bookmarks/{bookmarkId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // 允許一般訪客讀取 site_config
    match /site_config/{document} {
      allow read: if true;
    }
    
    // 留言板規則
    match /comments/{comment} {
      allow read, create: if true;
      allow update, delete: if isAdmin();
    }

    // 聯絡表單 (僅寫入)
    match /messages/{message} {
      allow create: if true;
    }
  }
}
